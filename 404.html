<!doctype html>
<html lang="ar" dir="rtl" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø§Ø³Ø¹Ø§Ø± Ø®Ø¯Ù…Ø§Øª Ø¨ÙˆØ±ØªØ±Ø§Ø¬</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
    
    * {
      font-family: 'Cairo', sans-serif;
      font-size: 18px;
    }
    
    /* Datalist and Select Styling â€” Black Ã— Gold luxury theme */
    input[list]::-webkit-calendar-picker-indicator {
      filter: invert(1);
      cursor: pointer;
    }

    datalist {
      background: #050505; /* very dark */
      color: #FFD700; /* gold */
      border: 1px solid #FFD700;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(255,215,0,0.06);
      padding: 6px;
    }

    option {
      background: #0a0a0a;
      color: #FFD700;
      padding: 10px 12px;
      font-size: 13px;
      transition: all 0.18s ease;
      border-radius: 8px;
    }

    option:hover {
      background: #B8860B; /* dark gold */
      color: #000;
      box-shadow: 0 8px 20px rgba(255,215,0,0.12), 0 0 12px rgba(255,215,0,0.06) inset;
    }

    select {
      background: #070707;
      border: 1px solid #FFD700;
      color: #FFD700;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      box-shadow: 0 8px 24px rgba(255,215,0,0.04);
    }

    select option {
      background: #0a0a0a;
      color: #FFD700;
      padding: 8px;
      border-radius: 6px;
    }

    select option:hover,
    select option:checked {
      background: #B8860B;
      color: #000;
      box-shadow: 0 8px 20px rgba(255,215,0,0.12);
    }

    /* Firefox specific */
    @-moz-document url-prefix() {
      option {
        background: #0a0a0a;
        color: #FFD700;
      }

      option:hover {
        background: #B8860B;
        color: #000;
      }
    }
    
    html, body {
      height: 100%;
      overflow: hidden;
      margin: 0;
      padding: 0;
    }
    
    .dashboard-wrapper {
      height: 100%;
      width: 100%;
      display: grid;
      grid-template-columns: 220px 1fr;
      background: #0a0a0a;
      overflow: hidden;
      position: relative;
      gap: 0;
    }
    
    /* Sidebar */
    .sidebar {
      background: linear-gradient(180deg, #1a1a1a 0%, #0f0f0f 100%);
      border-left: 2px solid #F2BC1B;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      padding: 10px;
      gap: 6px;
      position: relative;
      z-index: 100;
    }
    
    .sidebar::-webkit-scrollbar {
      width: 6px;
    }
    
    .sidebar::-webkit-scrollbar-track {
      background: #1a1a1a;
    }
    
    .sidebar::-webkit-scrollbar-thumb {
      background: #F2BC1B;
      border-radius: 3px;
    }
    
    .logo-section {
      text-align: center;
      padding: 10px 0 12px 0;
      border-bottom: 1px solid #333;
      margin-bottom: 8px;
    }
    
    .logo-section img {
      max-width: 100px;
      height: auto;
      margin: 0 auto 6px;
    }
    
    .logo-section h1 {
      font-size: 16px;
      font-weight: 700;
      color: #F2BC1B;
      margin: 0;
    }
    
    .service-item {
      background: #2a2a2a;
      border: 1px solid #404040;
      border-radius: 5px;
      padding: 8px 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .service-item:hover {
      background: #353535;
      border-color: #F2BC1B;
      transform: translateX(-2px);
    }
    
    .service-item.active {
      background: #F2BC1B;
      border-color: #F2BC1B;
      color: #000;
      font-weight: 700;
    }
    
    .service-item .icon {
      font-size: 18px;
      width: 22px;
      text-align: center;
      color: #F2BC1B;
    }
    
    .service-item.active .icon {
      color: #000;
    }
    
    .service-item .label {
      flex: 1;
      font-size: 14px;
      color: #F2BC1B;
      font-weight: 600;
    }
    
    .service-item.active .label {
      color: #000;
    }
    
    /* Submenu styling */
    .service-submenu {
      display: none;
      flex-direction: column;
      gap: 4px;
      margin-top: 4px;
      margin-right: 20px;
      padding-right: 8px;
      border-right: 2px solid #404040;
    }
    
    .service-submenu.show {
      display: flex;
    }
    
    .service-item.has-submenu .arrow {
      margin-right: auto;
      font-size: 12px;
      transition: transform 0.2s ease;
    }
    
    .service-item.has-submenu.expanded .arrow {
      transform: rotate(180deg);
    }
    
    .service-item.submenu-item {
      padding: 6px 8px;
      font-size: 13px;
    }
    
    /* Main Content */
    .main-content {
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: #0a0a0a;
      height: 100%;
    }
    
    /* Header Bar */
    .header-bar {
      background: #1a1a1a;
      border-bottom: 2px solid #F2BC1B;
      padding: 8px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }
    
    .header-bar h2 {
      font-size: 18px;
      font-weight: 700;
      color: #F2BC1B;
      margin: 0;
    }
    
    .header-bar .status {
      font-size: 13px;
      color: #10b981;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .status-dot {
      width: 7px;
      height: 7px;
      background: #10b981;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    /* Content Area */
    .content-area {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 12px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      grid-auto-rows: max-content;
      gap: 10px;
      align-content: start;
    }
    
    .content-area::-webkit-scrollbar {
      width: 8px;
    }
    
    .content-area::-webkit-scrollbar-track {
      background: #1a1a1a;
    }
    
    .content-area::-webkit-scrollbar-thumb {
      background: #F2BC1B;
      border-radius: 4px;
    }
    
    /* Form Sections */
    .form-section {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 5px;
      padding: 10px;
      height: fit-content;
    }
    
    .form-section.full-width {
      grid-column: 1 / -1;
    }

    /* Ensure insurance results span full page width (only results, not the search input) */
    #insuranceResults {
      grid-column: 1 / -1;
      width: 100%;
      box-sizing: border-box;
      padding: 0;
      margin-top: 8px;
    }

    #insuranceResults .data-table-container {
      grid-column: 1 / -1;
      width: 100%;
      margin: 0 0 15px 0;
    }

    #insuranceResults .table-scroll,
    #insuranceResults > div > .table-scroll {
      overflow-x: auto;
      width: 100%;
    }

    #insuranceResults .data-table {
      width: 100%;
      table-layout: auto;
    }
    
    .section-title {
      font-size: 14px;
      font-weight: 700;
      color: #F2BC1B;
      margin: 0 0 8px 0;
      padding-bottom: 5px;
      border-bottom: 1px solid #333;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
    }
    
    .form-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .form-field label {
      font-size: 13px;
      color: #999;
      font-weight: 600;
    }
    
    .form-control {
      background: #262626;
      border: 1px solid #404040;
      border-radius: 4px;
      padding: 8px 12px;
      color: #fff;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    
    .form-control:focus {
      outline: none;
      border-color: #F2BC1B;
      background: #2d2d2d;
    }
    
    .form-control::placeholder {
      color: #666;
    }
    
    /* Buttons */
    .btn-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 6px;
      margin-top: 6px;
    }
    
    .btn-option {
      background: #2a2a2a;
      border: 1px solid #404040;
      border-radius: 4px;
      padding: 10px 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
      font-size: 13px;
      color: #ccc;
      font-weight: 600;
    }
    
    .btn-option:hover {
      background: #353535;
      border-color: #F2BC1B;
    }
    
    .btn-option.active {
      background: #F2BC1B;
      border-color: #F2BC1B;
      color: #000;
      font-weight: 700;
    }
    
    .btn-primary {
      background: #F2BC1B;
      color: #000;
      border: none;
      padding: 12px 20px;
      border-radius: 5px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100%;
      margin-top: 10px;
    }
    
    .btn-primary:hover {
      background: #d9a616;
      transform: translateY(-2px);
    }
    
    /* Back Button */
    .btn-back {
      background: #F2BC1B;
      color: #000;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-back:hover {
      background: #d9a616;
      transform: translateY(-2px);
    }
    
  /* Data Table */
  .data-table-container {
  grid-column: 1 / -1;
  background: #1a1a1a;
  border: 1px solid #333;
  border-radius: 5px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  max-height: 350px;
}    
    .table-header {
      background: #F2BC1B;
      padding: 10px 12px;
      font-size: 15px;
      font-weight: 700;
      color: #000;
    }
    
    .table-scroll {
      overflow-y: auto;
      max-height: 300px;
    }
    
    .table-scroll::-webkit-scrollbar {
      width: 5px;
    }
    
    .table-scroll::-webkit-scrollbar-track {
      background: #262626;
    }
    
    .table-scroll::-webkit-scrollbar-thumb {
      background: #F2BC1B;
      border-radius: 3px;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table th {
      background: #262626;
      color: #F2BC1B;
      font-size: 14px;
      font-weight: 700;
      padding: 11px;
      text-align: center;
      border-bottom: 1px solid #404040;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
  .data-table td {
  padding: 10px 12px;
  font-size: 14px;
  color: #ccc;
  text-align: center;
  border-bottom: 1px solid #333;
}
    
    .data-table tr:hover td {
      background: #262626;
    }
    
    .data-table .highlight {
      color: #F2BC1B;
      font-weight: 600;
      font-size: 15px;
    }
    
    /* Info Boxes */
    .info-box {
      background: #1a3a52;
      border: 1px solid #3b82f6;
      border-radius: 4px;
      padding: 10px 12px;
      font-size: 13px;
      color: #93c5fd;
      margin-top: 7px;
    }
    
    .warning-box {
      background: #4a3a1a;
      border: 1px solid #f59e0b;
      border-radius: 4px;
      padding: 10px 12px;
      font-size: 13px;
      color: #fbbf24;
      margin-top: 7px;
    }
    
    .error-box {
      background: #4a1a1a;
      border: 1px solid #ef4444;
      border-radius: 4px;
      padding: 10px 12px;
      font-size: 13px;
      color: #fca5a5;
      margin-top: 7px;
    }
    
    /* Loading */
    .spinner {
      border: 2px solid #333;
      border-top: 2px solid #F2BC1B;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .hidden {
      display: none !important;
    }
    
    /* Fullscreen Iframe Container */
    .fullscreen-iframe-wrapper {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #0a0a0a;
      z-index: 1000;
      display: flex;
      flex-direction: column;
    }
    
    .fullscreen-iframe-header {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 10;
      background: transparent;
      border: none;
      padding: 0;
      pointer-events: none;
    }
    
    .fullscreen-iframe-header .btn-back {
      pointer-events: all;
      background: rgba(242, 188, 27, 0.95);
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .fullscreen-iframe-header .btn-back:hover {
      background: rgba(217, 166, 22, 0.95);
    }
    
    .fullscreen-iframe-container {
      flex: 1;
      width: 100%;
      overflow: hidden;
    }
    
    .fullscreen-iframe-container iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    
    /* Wash Cards Compact */
    .wash-cards-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-top: 6px;
    }
    
    .wash-card-compact {
      background: #262626;
      border: 1px solid #404040;
      border-radius: 4px;
      padding: 8px;
      transition: all 0.2s ease;
    }
    
    .wash-card-compact:hover {
      border-color: #F2BC1B;
      transform: translateY(-2px);
    }
    
    .wash-card-compact h3 {
      font-size: 14px;
      color: #F2BC1B;
      margin: 0 0 5px 0;
      font-weight: 700;
    }
    
    .wash-card-compact .price {
      font-size: 13px;
      color: #fff;
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .wash-card-compact ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .wash-card-compact li {
      font-size: 12px;
      color: #999;
      padding: 2px 0;
      padding-right: 14px;
      position: relative;
      line-height: 1.3;
    }
    
    .wash-card-compact li:before {
      content: "âœ“";
      position: absolute;
      right: 0;
      top: 2px;
      color: #10b981;
      font-weight: bold;
      font-size: 10px;
    }
    
    /* Copy Button */
    .copy-btn-small {
      background: #F2BC1B;
      color: #000;
      border: none;
      border-radius: 3px;
      padding: 6px 8px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
      margin-top: 5px;
      transition: all 0.2s ease;
    }
    
    .copy-btn-small:hover {
      background: #d9a616;
    }
    
    .copy-btn-small.success {
      background: #10b981;
      color: #fff;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div class="dashboard-wrapper" id="dashboardWrapper"><!-- Sidebar -->
   <aside class="sidebar" id="sidebar">
    <div class="logo-section"><img src="https://i.top4top.io/p_35860o72q1.png" alt="Logo">
     <h1 id="siteTitle">Ø®Ø¯Ù…Ø§Øª Ø¨ÙˆØ±ØªØ±Ø§Ø¬</h1>
    </div>
    <div class="service-item" data-service="tow"><span class="icon">ğŸšš</span> <span class="label">ÙˆÙ†Ø´Ø§Øª</span>
    </div>
    <div class="service-item has-submenu" data-service="battery"><span class="icon">ğŸ”‹</span> <span class="label">Ø¨Ø·Ø§Ø±ÙŠØ©</span> <span class="arrow">â–¼</span>
    </div>
    <div class="service-submenu" id="batterySubmenu">
     <div class="service-item submenu-item" data-service="batterySubscription"><span class="label">Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ø·Ø§Ø±ÙŠØ©</span>
     </div>
     <div class="service-item submenu-item" data-service="newBattery"><span class="label">Ø¨Ø·Ø§Ø±ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</span>
     </div>
     <div class="service-item submenu-item" data-service="batteryInstall"><span class="label">ØªØ±ÙƒÙŠØ¨ Ø¨Ø·Ø§Ø±ÙŠØ©</span>
     </div>
    </div>
    <div class="service-item" data-service="fuel"><span class="icon">â›½</span> <span class="label">Ø®Ø¯Ù…Ø© Ø¨Ù†Ø²ÙŠÙ†</span>
    </div>
    <div class="service-item" data-service="unlock"><span class="icon">ğŸ”“</span> <span class="label">ÙØªØ­ Ù‚ÙÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</span>
    </div>
    <div class="service-item has-submenu" data-service="tire"><span class="icon">ğŸ“€</span> <span class="label">Ø§Ù„Ø¹Ù†Ø§ÙŠØ© Ø¨Ø§Ù„Ø¥Ø·Ø§Ø±Ø§Øª</span> <span class="arrow">â–¼</span>
    </div>
    <div class="service-submenu" id="tireSubmenu">
     <div class="service-item submenu-item" data-service="puncture"><span class="label">Ø¨Ù†Ø´Ø±</span>
     </div>
     <div class="service-item submenu-item" data-service="tireIncrease"><span class="label">Ø²ÙŠØ§Ø¯Ø§Øª Ø§Ù„ØªÙˆØ§ÙŠØ±</span>
     </div>
     <div class="service-item submenu-item" data-service="tireSheet"><span class="label">Ø´ÙŠØª Ø§Ù„ØªÙˆØ§ÙŠØ±</span>
     </div>
     <div class="service-item submenu-item" data-service="balance"><span class="label">Ù…ÙŠØ²Ø§Ù† ÙˆØªØ±ÙƒÙŠØ¨</span>
     </div>
    </div>
    <div class="service-item" data-service="mechanical"><span class="icon">ğŸ”©</span> <span class="label">Ø®Ø¯Ù…Ø§Øª Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©</span>
    </div>
    <div class="service-item" data-service="carwash"><span class="icon">ğŸ’§</span> <span class="label">ØºØ³ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</span>
    </div>
    <div class="service-item" data-service="insurance"><span class="icon">ğŸ›¡ï¸</span> <span class="label">ØªØ£Ù…ÙŠÙ†Ø§Øª</span>
    </div>
    <div class="service-item" data-service="refunds"><span class="icon">ğŸ’°</span> <span class="label">Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹Ø©</span>
    </div>
   </aside><!-- Main Content -->
   <main class="main-content"><!-- Header Bar -->
    <header class="header-bar">
     <h2 id="serviceTitle">Ø§Ø®ØªØ± Ø®Ø¯Ù…Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</h2>
     <div class="status"><span class="status-dot"></span> <span>Ù…ØªØµÙ„</span>
     </div>
    </header><!-- Content Area -->
    <div id="contentArea" class="content-area">
     <div style="grid-column: 1 / -1; text-align: center; padding: 40px 20px;">
      <div style="font-size: 48px; margin-bottom: 16px;">
       ğŸ“Š
      </div>
      <h3 style="color: #F2BC1B; font-size: 18px; margin-bottom: 8px;">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h3>
      <p style="color: #999; font-size: 14px;">Ø§Ø®ØªØ± Ø®Ø¯Ù…Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù„Ù„Ø¨Ø¯Ø¡</p>
     </div>
    </div>
   </main>
  </div><!-- Fullscreen Iframe Wrapper (Hidden by default) -->
  <div id="fullscreenIframeWrapper" class="fullscreen-iframe-wrapper hidden">
   <div class="fullscreen-iframe-header"><button class="btn-back" onclick="closeFullscreenIframe()"> <span>â†</span> <span>Ø±Ø¬ÙˆØ¹</span> </button>
   </div>
   <div class="fullscreen-iframe-container" id="fullscreenIframeContainer">
   </div>
  </div>
  <script>
    // Configuration
    const defaultConfig = {
      site_title: 'Ø®Ø¯Ù…Ø§Øª Ø¨ÙˆØ±ØªØ±Ø§Ø¬',
      sheet_id: '1x2ongtstODqEEWh_jAwN8zLHjsYeIppk8EH_Q1CXMzk',
      currency: 'Ø¯.Ùƒ'
    };

    // Ø«Ø§Ø¨Øª Ø§Ù„Ø²ÙŠØ§Ø¯Ø© Ù„Ø®Ø¯Ù…Ø© ÙØªØ­ Ø§Ù„Ù‚ÙÙ„ (Ù…Ù‚Ø¯Ø§Ø± Ø«Ø§Ø¨Øª ÙŠØ¶Ø§Ù Ù„Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ)
    const LOCK_SURCHARGE = 10; // Ø¯.Ùƒ

    let config = { ...defaultConfig };
    let sheetsData = {};
    let currentService = '';
    let formData = {};
    let carWashData = [];
    let lastIframeState = null; // Store last iframe state

    // Initialize Element SDK
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (newConfig) => {
          config = { ...defaultConfig, ...newConfig };
          document.getElementById('siteTitle').textContent = config.site_title;
          
          if (newConfig.sheet_id && newConfig.sheet_id !== sheetsData.currentSheetId) {
            await loadAllSheets();
          }
        },
        mapToCapabilities: () => ({
          recolorables: [],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (cfg) => new Map([
          ['site_title', cfg.site_title || defaultConfig.site_title],
          ['sheet_id', cfg.sheet_id || defaultConfig.sheet_id],
          ['currency', cfg.currency || defaultConfig.currency]
        ])
      });
    }

    // Company mapping
    const companyMapping = {
      'Ø¨ÙˆØ±ØªØ±Ø§Ø¬': 'portarage towtruk',
      'Ù‡ÙŠØ±Ùˆ ÙˆØ±ÙƒØ³': 'hero.works',
      'Ø£Ø­Ù…Ø¯ Ø§Ù„ØºØ§Ù†Ù…': 'Ahmed Al-Ghanem',
      'Ø¨ÙŠÙƒÙˆÙƒ ÙƒÙˆÙ†Ø³ÙŠØ±Ø¬': 'Peacock Concierge',
      'Ø¨Ø±ÙˆØ¬ÙƒØª Ø¥ÙƒØ³ Ø±ÙŠØ³Ù†Ù‚': 'ProjX Racing',
      'ÙŠØ§Ù…Ø§Ù‡Ø§ Ù…ÙˆØªÙˆØ±': 'Yamaha Motor',
      'ÙÙˆÙ„Øª Ù‚Ø§Ø±Ø§Ø¬': 'Vault Garage',
      'Ø¬ÙŠÙ„ÙŠ': 'Geely',
      'Ø§ÙˆØªÙˆ ÙƒØ§Ø¨ÙŠØªØ§Ù„': 'Auto Capital'
    };
    
    const companies = Object.keys(companyMapping);

    // Parse CSV
    function parseCSV(csvText) {
      const rows = [];
      const lines = csvText.split('\n');
      
      for (let line of lines) {
        if (!line.trim()) continue;
        
        const cells = [];
        let cell = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          
          if (char === '"') {
            if (inQuotes && line[i + 1] === '"') {
              cell += '"';
              i++;
            } else {
              inQuotes = !inQuotes;
            }
          } else if (char === ',' && !inQuotes) {
            cells.push(cell.replace(/^"|"$/g, ''));
            cell = '';
          } else {
            cell += char;
          }
        }
        cells.push(cell.replace(/^"|"$/g, ''));
        rows.push(cells);
      }
      
      return rows;
    }

    // Load all sheets
    async function loadAllSheets() {
      try {
        const sheetId = config.sheet_id;
        
        const sheetNames = [
          'portarage towtruk',
          'hero.works',
          'Ahmed Al-Ghanem',
          'Peacock Concierge',
          'ProjX Racing',
          'Yamaha Motor',
          'Vault Garage',
          'Geely',
          'Auto Capital',
          'Ø®Ø¯Ù…Ø§Øª5',
          'Ù…ÙŠØ²Ø§Ù† ÙˆØªØ±ÙƒÙŠØ¨',
          'Ø®Ø¯Ù…Ø§Øª Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©',
          'ØªØ±ÙƒÙŠØ¨ Ø¨Ø·Ø§Ø±ÙŠØ©',
          'ØªØ£Ù…ÙŠÙ† ÙˆØ±Ø¨Ù‡',
          'ØªØ£Ù…ÙŠÙ† ØµÙÙŠÙ†Ù‡ VIP',
          'ØªØ£Ù…ÙŠÙ† Ø¥ÙŠÙ„Ø§Ù',
          'ÙØªØ­ Ù‚ÙÙ„'
        ];
        
        sheetsData = { currentSheetId: sheetId };
        
        for (const sheetName of sheetNames) {
          try {
            const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
            const response = await fetch(csvUrl);
            
            if (response.ok) {
              const csvText = await response.text();
              const rows = parseCSV(csvText);
              sheetsData[sheetName] = rows;
            }
          } catch (err) {
            console.log(`Could not load sheet: ${sheetName}`);
          }
        }
        
      } catch (error) {
        console.error('Error loading sheets:', error);
      }
    }

    // Fullscreen iframe functions
    function openFullscreenIframe(url, title) {
      const wrapper = document.getElementById('fullscreenIframeWrapper');
      const container = document.getElementById('fullscreenIframeContainer');
      
      // Store state before opening
      lastIframeState = {
        url: url,
        title: title,
        service: currentService,
        formData: { ...formData }
      };
      
      container.innerHTML = `<iframe src="${url}" title="${title}"></iframe>`;
      wrapper.classList.remove('hidden');
      
      // Hide the main dashboard
      document.getElementById('dashboardWrapper').style.display = 'none';
    }

    window.closeFullscreenIframe = function() {
      const wrapper = document.getElementById('fullscreenIframeWrapper');
      const container = document.getElementById('fullscreenIframeContainer');
      
      wrapper.classList.add('hidden');
      container.innerHTML = '';
      
      // Show the main dashboard again
      document.getElementById('dashboardWrapper').style.display = 'grid';
      
      // Don't reset the service - keep the current state
      // The user will see the same service they had before opening the iframe
    };

    // Service Selection
    document.addEventListener('click', (e) => {
      const serviceItem = e.target.closest('.service-item');
      if (serviceItem) {
        // Handle submenu toggle for battery and tire
        if ((serviceItem.dataset.service === 'battery' || serviceItem.dataset.service === 'tire') && serviceItem.classList.contains('has-submenu')) {
          serviceItem.classList.toggle('expanded');
          const submenuId = serviceItem.dataset.service === 'battery' ? 'batterySubmenu' : 'tireSubmenu';
          const submenu = document.getElementById(submenuId);
          submenu.classList.toggle('show');
          return;
        }
        
        // Clear all active states
        document.querySelectorAll('.service-item').forEach(item => {
          item.classList.remove('active');
        });
        
        serviceItem.classList.add('active');
        
        currentService = serviceItem.dataset.service;
        formData = {};
        
        const serviceTitles = {
          'tow': 'Ø®Ø¯Ù…Ø© ÙˆÙ†Ø´Ø§Øª',
          'batterySubscription': 'Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ø·Ø§Ø±ÙŠØ©',
          'newBattery': 'Ø¨Ø·Ø§Ø±ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©',
          'batteryInstall': 'ØªØ±ÙƒÙŠØ¨ Ø¨Ø·Ø§Ø±ÙŠØ©',
          'fuel': 'Ø®Ø¯Ù…Ø© Ø¨Ù†Ø²ÙŠÙ†',
          'unlock': 'ÙØªØ­ Ù‚ÙÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø©',
          'tireSheet': 'Ø´ÙŠØª Ø§Ù„ØªÙˆØ§ÙŠØ±',
          'tireIncrease': 'Ø²ÙŠØ§Ø¯Ø§Øª Ø§Ù„ØªÙˆØ§ÙŠØ±',
          'puncture': 'Ø¨Ù†Ø´Ø±',
          'balance': 'Ù…ÙŠØ²Ø§Ù† ÙˆØªØ±ÙƒÙŠØ¨',
          'mechanical': 'Ø®Ø¯Ù…Ø§Øª Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©',
          'carwash': 'ØºØ³ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª',
          'insurance': 'ØªØ£Ù…ÙŠÙ†Ø§Øª',
          'refunds': 'Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹Ø©'
        };
        
        document.getElementById('serviceTitle').textContent = serviceTitles[currentService];
        
        switch(currentService) {
          case 'tow':
            renderTowInterface();
            break;
          case 'batterySubscription':
            renderBatterySubscriptionInterface();
            break;
          case 'newBattery':
            openFullscreenIframe('https://portaragebatteries.netlify.app/', 'Ø¨Ø·Ø§Ø±ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©');
            break;
          case 'batteryInstall':
            renderBatteryInstallInterface();
            break;
          case 'fuel':
            renderFuelInterface();
            break;
          case 'unlock':
            renderLockInterface();
            break;
          case 'tireSheet':
            openFullscreenIframe('https://portiers.netlify.app/', 'Ø´ÙŠØª Ø§Ù„ØªÙˆØ§ÙŠØ±');
            break;
          case 'tireIncrease':
            openFullscreenIframe('https://portaragetiers.netlify.app/', 'Ø²ÙŠØ§Ø¯Ø§Øª Ø§Ù„ØªÙˆØ§ÙŠØ±');
            break;
          case 'puncture':
            renderPunctureService();
            break;
          case 'balance':
            renderBalanceService();
            break;
          case 'mechanical':
            renderMechanicalInterface();
            break;
          case 'carwash':
            renderCarWashInterface();
            break;
          case 'insurance':
            renderInsuranceInterface();
            break;
          case 'refunds':
            renderRefundsInterface();
            break;
        }
      }
    });

    // Render Battery Subscription Interface (was old "battery" service)
    function renderBatterySubscriptionInterface() {
      renderServiceWithDatalist('Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ø·Ø§Ø±ÙŠØ©', 'Ø®Ø¯Ù…Ø§Øª5', [0, 1, 2, 4, 5, 6], 
        '<div class="info-box">ÙÙŠ Ø­Ø§Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠØ¨ÙŠ ÙØ­Øµ Ø¨Ø·Ø§Ø±ÙŠØ©: 10 Ø¯.Ùƒ ØªÙ†Ø®ØµÙ… Ù…Ù† Ø³Ø¹Ø± Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©</div>');
    }

    // Render Tow Interface
    function renderTowInterface() {
      const contentArea = document.getElementById('contentArea');
      contentArea.innerHTML = `
        <div class="form-section">
          <h3 class="section-title">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬Ù‡Ø©</h3>
          <div class="btn-grid" style="grid-template-columns: 1fr;">
            <button class="btn-option active" data-company="Ø¨ÙˆØ±ØªØ±Ø§Ø¬">Ø¨ÙˆØ±ØªØ±Ø§Ø¬</button>
          </div>
          <button id="toggleCompanies" class="btn-option" style="width: 100%; margin-top: 8px; background: #353535; border-color: #666;">
            â¬‡ï¸ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
          </button>
          <div id="moreCompanies" class="hidden" style="margin-top: 8px;">
            <div class="btn-grid">
              ${companies.slice(1, 5).map(company => `
                <button class="btn-option" data-company="${company}">${company}</button>
              `).join('')}
            </div>
            <div class="btn-grid">
              ${companies.slice(5, 9).map(company => `
                <button class="btn-option" data-company="${company}">${company}</button>
              `).join('')}
            </div>
          </div>
        </div>
        
        <div id="towTypeSection" class="form-section hidden">
          <h3 class="section-title">Ù†ÙˆØ¹ Ø§Ù„ÙˆÙ†Ø´</h3>
          <div class="btn-grid" id="towTypeButtons" style="grid-template-columns: repeat(2, 1fr);">
            <button class="btn-option" data-type="normal">ÙˆÙ†Ø´ Ø¹Ø§Ø¯ÙŠ</button>
            <button class="btn-option" data-type="flatbed">ÙˆÙ†Ø´ ÙÙ„ Ø¯Ø§ÙˆÙ†</button>
          </div>
          
          <div id="lockedOption" class="hidden" style="margin-top: 10px;">
            <h3 class="section-title">ÙˆÙ†Ø´ Ù…Ø³ÙƒØ±</h3>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; background: #262626; border-radius: 4px; border: 1px solid #404040;">
              <input type="checkbox" id="lockedCheckbox" style="width: 18px; height: 18px; cursor: pointer; accent-color: #F2BC1B;">
              <span style="color: #F2BC1B; font-size: 12px; font-weight: 600;">ØªÙØ¹ÙŠÙ„ ÙˆÙ†Ø´ Ù…Ø³ÙƒØ± (+5 Ø¯.Ùƒ)</span>
            </label>
            <div id="lockedYesNote" class="warning-box hidden">
              <strong>âš ï¸ ØªÙ†ÙˆÙŠÙ‡:</strong> Ø¥Ø°Ø§ Ø§Ù„Ù‚ÙŠØ± Ù…Ø§ ÙŠØªØ¨ÙˆØ´ Ø§Ùˆ Ø§Ù„Ø³ÙŠØ§Ø±Ø© ÙÙŠÙ‡Ø§ Ø­Ø§Ø¯Ø« Ù…Ø§ Ù†Ù‚Ø¯Ø± Ù†Ø´ÙŠÙ„Ù‡Ø§ Ø¨Ø§Ù„ÙˆÙ†Ø´ Ø§Ù„Ù…Ø³ÙƒØ±
            </div>
          </div>
          
          <div id="flatbedOnlyNote" class="info-box hidden" style="margin-top: 10px;">
            <strong>â„¹ï¸ ØªÙ†ÙˆÙŠÙ‡:</strong> Ø§Ù„Ø³ÙŠØ§Ø±Ø© ØªØ­ØªØ§Ø¬ ÙˆÙ†Ø´ ÙÙ„ Ø¯Ø§ÙˆÙ† Ø¨Ø¯ÙˆÙ† Ù…Ø³ÙƒØ± (+10 Ø¯.Ùƒ Ø±Ø³ÙˆÙ… Ø¹Ø±Ø¨Ø§Ù†Ø§Øª)
          </div>
          
          <div id="flatbedExtraChargesSection" class="hidden" style="margin-top: 10px;">
            <h3 class="section-title">Ø±Ø³ÙˆÙ… Ø¥Ø¶Ø§ÙÙŠØ©</h3>
            <div class="form-field">
              <label>Ù‡Ù„ Ø§Ù„Ù‚ÙŠØ± Ù…Ø§ ÙŠØªØ¨ÙˆØ´ Ø£Ùˆ Ø§Ù„Ø³ÙŠØ§Ø±Ø© ÙÙŠÙ‡Ø§ Ø­Ø§Ø¯Ø«ØŸ</label>
              <select id="flatbedExtraChargesSelect" class="form-control">
                <option value="no">Ù„Ø§</option>
                <option value="yes">Ù†Ø¹Ù… (+10 Ø¯.Ùƒ Ø±Ø³ÙˆÙ… Ø¹Ø±Ø¨Ø§Ù†Ø§Øª)</option>
              </select>
            </div>
            <div id="flatbedExtraChargesNote" class="warning-box hidden">
              <strong>âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> ÙÙŠ Ø­Ø§Ù„ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø®ÙØ±: 5 Ø¯.Ùƒ Ù„ÙƒÙ„ Ù†ØµÙ Ø³Ø§Ø¹Ø© | 10 Ø¯.Ùƒ Ù„ÙƒÙ„ Ø³Ø§Ø¹Ø©
            </div>
          </div>
        </div>
        
        <div id="towLocationsSection" class="form-section full-width hidden">
          <h3 class="section-title">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</h3>
          <div class="form-grid">
            <div class="form-field">
              <label>Ù…Ù† Ø£ÙŠÙ†</label>
              <input type="text" list="fromLocations" id="fromSelect" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø£Ùˆ Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹">
              <datalist id="fromLocations"></datalist>
            </div>
            <div class="form-field">
              <label>Ø¥Ù„Ù‰ Ø£ÙŠÙ†</label>
              <input type="text" list="toLocations" id="toSelect" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø£Ùˆ Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹">
              <datalist id="toLocations"></datalist>
            </div>
          </div>
          <div id="extraChargesSection" class="hidden">
            <div class="form-field" style="margin-top: 10px;">
              <label>Ù‡Ù„ Ø§Ù„Ù‚ÙŠØ± Ù…Ø§ ÙŠØªØ¨ÙˆØ´ Ø£Ùˆ Ø§Ù„Ø³ÙŠØ§Ø±Ø© ÙÙŠÙ‡Ø§ Ø­Ø§Ø¯Ø«ØŸ</label>
              <select id="extraChargesSelect" class="form-control">
                <option value="no">Ù„Ø§</option>
                <option value="yes">Ù†Ø¹Ù… (+10 Ø¯.Ùƒ Ø±Ø³ÙˆÙ… Ø¹Ø±Ø¨Ø§Ù†Ø§Øª)</option>
              </select>
            </div>
            <div id="extraChargesNote" class="warning-box hidden">
              <strong>âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> ÙÙŠ Ø­Ø§Ù„ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø®ÙØ±: 5 Ø¯.Ùƒ Ù„ÙƒÙ„ Ù†ØµÙ Ø³Ø§Ø¹Ø© | 10 Ø¯.Ùƒ Ù„ÙƒÙ„ Ø³Ø§Ø¹Ø©
            </div>
          </div>
          <div id="flatbedPortarageExtraChargesSection" class="hidden">
            <div class="form-field" style="margin-top: 10px;">
              <label>Ù‡Ù„ Ø§Ù„Ù‚ÙŠØ± Ù…Ø§ ÙŠØªØ¨ÙˆØ´ Ø£Ùˆ Ø§Ù„Ø³ÙŠØ§Ø±Ø© ÙÙŠÙ‡Ø§ Ø­Ø§Ø¯Ø«ØŸ</label>
              <select id="flatbedPortarageExtraChargesSelect" class="form-control">
                <option value="no">Ù„Ø§</option>
                <option value="yes">Ù†Ø¹Ù… (+10 Ø¯.Ùƒ Ø±Ø³ÙˆÙ… Ø¹Ø±Ø¨Ø§Ù†Ø§Øª)</option>
              </select>
            </div>
            <div id="flatbedPortarageExtraChargesNote" class="warning-box hidden">
              <strong>âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> ÙÙŠ Ø­Ø§Ù„ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø®ÙØ±: 5 Ø¯.Ùƒ Ù„ÙƒÙ„ Ù†ØµÙ Ø³Ø§Ø¹Ø© | 10 Ø¯.Ùƒ Ù„ÙƒÙ„ Ø³Ø§Ø¹Ø©
            </div>
          </div>
        </div>
        
        <div id="towResultSection" class="data-table-container hidden">
          <div class="table-header">Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­Ø³Ø§Ø¨</div>
          <div class="table-scroll">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Ø§Ù„Ø¨ÙŠØ§Ù†</th>
                  <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                </tr>
              </thead>
              <tbody id="towResultBody">
              </tbody>
            </table>
          </div>
        </div>
      `;
      
      // Toggle companies button
      const toggleBtn = document.getElementById('toggleCompanies');
      const moreCompanies = document.getElementById('moreCompanies');
      let companiesVisible = false;
      
      toggleBtn.onclick = () => {
        companiesVisible = !companiesVisible;
        if (companiesVisible) {
          moreCompanies.classList.remove('hidden');
          toggleBtn.textContent = 'â¬†ï¸ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ø£Ø®Ø±Ù‰';
        } else {
          moreCompanies.classList.add('hidden');
          toggleBtn.textContent = 'â¬‡ï¸ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ø£Ø®Ø±Ù‰';
          
          // Reset to Ø¨ÙˆØ±ØªØ±Ø§Ø¬ when hiding
          const portarageBtn = document.querySelector('[data-company="Ø¨ÙˆØ±ØªØ±Ø§Ø¬"]');
          if (portarageBtn && !portarageBtn.classList.contains('active')) {
            document.querySelectorAll('[data-company]').forEach(b => b.classList.remove('active'));
            portarageBtn.classList.add('active');
            
            formData.companyArabic = 'Ø¨ÙˆØ±ØªØ±Ø§Ø¬';
            formData.company = 'portarage towtruk';
            formData.isLocked = false;
            formData.gearWorks = true;
            updateTowTypeOptions();
          }
        }
      };
      
      // Company selection
      document.querySelectorAll('[data-company]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('[data-company]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          
          formData.companyArabic = btn.dataset.company;
          formData.company = companyMapping[btn.dataset.company];
          
          // Clear previous state
          formData.towType = null;
          formData.from = null;
          formData.to = null;
          formData.isLocked = false;
          formData.extraCharges = 'no';
          
          // Hide sections
          document.getElementById('towTypeSection').classList.add('hidden');
          document.getElementById('towLocationsSection').classList.add('hidden');
          document.getElementById('towResultSection').classList.add('hidden');
          document.getElementById('lockedOption').classList.add('hidden');
          document.getElementById('lockedYesNote').classList.add('hidden');
          document.getElementById('flatbedOnlyNote').classList.add('hidden');
          
          updateTowTypeOptions();
        });
      });
      
      // Set default to Ø¨ÙˆØ±ØªØ±Ø§Ø¬
      formData.companyArabic = 'Ø¨ÙˆØ±ØªØ±Ø§Ø¬';
      formData.company = 'portarage towtruk';
      formData.isLocked = false;
      formData.gearWorks = true;
      updateTowTypeOptions();
    }

    function updateTowTypeOptions() {
      const towTypeSection = document.getElementById('towTypeSection');
      const sheetName = formData.company;
      
      if (!sheetName || !sheetsData[sheetName]) {
        towTypeSection.classList.add('hidden');
        return;
      }
      
      towTypeSection.classList.remove('hidden');
      
      // Check which tow types are available
      const rows = sheetsData[sheetName];
      let hasNormal = false;
      let hasFlatbed = false;
      
      for (let i = 2; i < rows.length; i++) {
        const row = rows[i];
        if (row[4] || row[1]) hasNormal = true;
        if (row[12] || row[9]) hasFlatbed = true;
      }
      
      // Update buttons visibility
      const towTypeButtons = document.getElementById('towTypeButtons');
      const buttons = towTypeButtons.querySelectorAll('.btn-option');
      
      buttons.forEach(btn => {
        const type = btn.dataset.type;
        if (type === 'normal' && !hasNormal) {
          btn.style.display = 'none';
        } else if (type === 'flatbed' && !hasFlatbed) {
          btn.style.display = 'none';
        } else {
          btn.style.display = 'block';
        }
      });
      
      const visibleButtons = Array.from(buttons).filter(btn => btn.style.display !== 'none');
      towTypeButtons.style.gridTemplateColumns = `repeat(${visibleButtons.length}, 1fr)`;
      
      buttons.forEach(btn => btn.classList.remove('active'));
      
      if (!formData.towType) {
        document.getElementById('towLocationsSection').classList.add('hidden');
        document.getElementById('towResultSection').classList.add('hidden');
        document.getElementById('lockedOption').classList.add('hidden');
      }
      
      // Tow type selection
      buttons.forEach(btn => {
        btn.onclick = () => {
          buttons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          
          formData.towType = btn.dataset.type;
          
          // Reset all sections
          document.getElementById('towResultSection').classList.add('hidden');
          document.getElementById('towLocationsSection').classList.add('hidden');
          formData.from = null;
          formData.to = null;
          
          const fromSelect = document.getElementById('fromSelect');
          const toSelect = document.getElementById('toSelect');
          if (fromSelect) fromSelect.value = '';
          if (toSelect) toSelect.value = '';
          
          const lockedOption = document.getElementById('lockedOption');
          const flatbedOnlyNote = document.getElementById('flatbedOnlyNote');
          const lockedCheckbox = document.getElementById('lockedCheckbox');
          const flatbedExtraChargesSection = document.getElementById('flatbedExtraChargesSection');
          
          if (formData.towType === 'flatbed') {
            if (formData.companyArabic === 'Ø¨ÙˆØ±ØªØ±Ø§Ø¬') {
              lockedOption.classList.remove('hidden');
              flatbedOnlyNote.classList.add('hidden');
              flatbedExtraChargesSection.classList.add('hidden');
              
              if (formData.isLocked === undefined) {
                formData.isLocked = false;
              }
              
              if (lockedCheckbox) {
                lockedCheckbox.checked = formData.isLocked;
              }
              
              if (lockedCheckbox) {
                lockedCheckbox.onchange = () => {
                  formData.isLocked = lockedCheckbox.checked;
                  
                  const lockedYesNote = document.getElementById('lockedYesNote');
                  
                  if (formData.isLocked) {
                    lockedYesNote.classList.remove('hidden');
                  } else {
                    lockedYesNote.classList.add('hidden');
                  }
                  
                  if (formData.from && formData.to) {
                    calculateTowPrice();
                  }
                };
              }
            } else {
              // For other companies - NO gear question for flatbed
              lockedOption.classList.add('hidden');
              flatbedOnlyNote.classList.add('hidden');
              document.getElementById('lockedYesNote').classList.add('hidden');
              flatbedExtraChargesSection.classList.add('hidden');
              formData.isLocked = false;
              formData.flatbedExtraCharges = 'no';
            }
          } else {
            lockedOption.classList.add('hidden');
            flatbedOnlyNote.classList.add('hidden');
            flatbedExtraChargesSection.classList.add('hidden');
            document.getElementById('lockedYesNote').classList.add('hidden');
            document.getElementById('flatbedExtraChargesNote').classList.add('hidden');
            formData.isLocked = false;
            formData.flatbedExtraCharges = 'no';
          }
          
          updateTowLocations();
        };
      });
    }

    function updateTowLocations() {
      const towLocationsSection = document.getElementById('towLocationsSection');
      towLocationsSection.classList.remove('hidden');
      
      const routes = getTowRoutes(formData.company, formData.towType);
      const fromLocations = [...new Set(routes.map(r => r.from))].filter(Boolean);
      
      const fromDatalist = document.getElementById('fromLocations');
      fromDatalist.innerHTML = fromLocations.map(loc => `<option value="${loc}">${loc}</option>`).join('');
      
      const fromSelect = document.getElementById('fromSelect');
      const toSelect = document.getElementById('toSelect');
      
      fromSelect.oninput = () => {
        formData.from = fromSelect.value;
        
        const currentTo = toSelect.value;
        
        if (formData.from) {
          const toLocations = [...new Set(routes.filter(r => r.from === formData.from).map(r => r.to))].filter(Boolean);
          const toDatalist = document.getElementById('toLocations');
          toDatalist.innerHTML = toLocations.map(loc => `<option value="${loc}">${loc}</option>`).join('');
          
          if (currentTo && toLocations.includes(currentTo)) {
            toSelect.value = currentTo;
            formData.to = currentTo;
          } else {
            toSelect.value = '';
            formData.to = null;
            document.getElementById('towResultSection').classList.add('hidden');
          }
        } else {
          document.getElementById('towResultSection').classList.add('hidden');
        }
      };
      
      toSelect.oninput = () => {
        formData.to = toSelect.value;
        const currentToInput = toSelect.value.toLowerCase();
      if (formData.from) {
        const routes = getTowRoutes(formData.company, formData.towType);
        const filteredToLocations = [...new Set(
          routes
            .filter(r => r.from === formData.from && r.to.toLowerCase().includes(currentToInput))
            .map(r => r.to)
        )].filter(Boolean);

        const toDatalist = document.getElementById('toLocations');
        toDatalist.innerHTML = filteredToLocations.map(loc => `<option value="${loc}">${loc}</option>`).join('');
      }
        if (!formData.to) {
          document.getElementById('towResultSection').classList.add('hidden');
          
          // Hide gear question sections
          document.getElementById('extraChargesSection').classList.add('hidden');
          document.getElementById('flatbedPortarageExtraChargesSection').classList.add('hidden');
          return;
        }
        
        if (formData.to) {
          // Show gear question ONLY for Ø¨ÙˆØ±ØªØ±Ø§Ø¬ flatbed
          if (formData.companyArabic === 'Ø¨ÙˆØ±ØªØ±Ø§Ø¬' && formData.towType === 'flatbed') {
            document.getElementById('flatbedPortarageExtraChargesSection').classList.remove('hidden');
            document.getElementById('extraChargesSection').classList.add('hidden');
            
            const flatbedPortarageExtraChargesSelect = document.getElementById('flatbedPortarageExtraChargesSelect');
            if (!formData.flatbedPortarageExtraCharges) {
              formData.flatbedPortarageExtraCharges = 'no';
            }
            flatbedPortarageExtraChargesSelect.value = formData.flatbedPortarageExtraCharges;
            
            flatbedPortarageExtraChargesSelect.onchange = () => {
              formData.flatbedPortarageExtraCharges = flatbedPortarageExtraChargesSelect.value;
              
              if (formData.flatbedPortarageExtraCharges === 'yes') {
                document.getElementById('flatbedPortarageExtraChargesNote').classList.remove('hidden');
              } else {
                document.getElementById('flatbedPortarageExtraChargesNote').classList.add('hidden');
              }
              
              calculateTowPrice();
            };
          } else if (formData.companyArabic === 'Ø¨ÙˆØ±ØªØ±Ø§Ø¬' && formData.towType === 'normal') {
            // For Ø¨ÙˆØ±ØªØ±Ø§Ø¬ normal tow
            document.getElementById('extraChargesSection').classList.remove('hidden');
            document.getElementById('flatbedPortarageExtraChargesSection').classList.add('hidden');
            
            const extraChargesSelect = document.getElementById('extraChargesSelect');
            if (!formData.extraCharges) {
              formData.extraCharges = 'no';
            }
            extraChargesSelect.value = formData.extraCharges;
            
            extraChargesSelect.onchange = () => {
              formData.extraCharges = extraChargesSelect.value;
              
              if (formData.extraCharges === 'yes') {
                document.getElementById('extraChargesNote').classList.remove('hidden');
              } else {
                document.getElementById('extraChargesNote').classList.add('hidden');
              }
              
              calculateTowPrice();
            };
          } else {
            // For other companies - no gear question at all
            document.getElementById('extraChargesSection').classList.add('hidden');
            document.getElementById('flatbedPortarageExtraChargesSection').classList.add('hidden');
          }
          
          // Always recalculate when "to" location changes
          calculateTowPrice();
        }
      };
    }

    function getTowRoutes(sheetName, towType) {
      const rows = sheetsData[sheetName];
      if (!rows || rows.length < 3) return [];
      
      const routes = [];
      
      for (let i = 2; i < rows.length; i++) {
        const row = rows[i];
        
        if (towType === 'normal') {
          const from = row[6];
          const toF = row[5];
          const toC = row[2];
          const priceE = row[4];
          const priceB = row[1];
          
          if (from && toF && priceE) {
            routes.push({ from, to: toF, price: priceE, cancelCol: 3 });
          }
          if (from && toC && priceB) {
            routes.push({ from, to: toC, price: priceB, cancelCol: 0 });
          }
        } else if (towType === 'flatbed') {
          const from = row[14];
          const toN = row[13];
          const toK = row[10];
          const priceM = row[12];
          const priceJ = row[9];
          
          if (from && toN && priceM) {
            routes.push({ from, to: toN, price: priceM, cancelCol: 11 });
          }
          if (from && toK && priceJ) {
            routes.push({ from, to: toK, price: priceJ, cancelCol: 8 });
          }
        }
      }
      
      return routes;
    }

    function calculateTowPrice() {
      const routes = getTowRoutes(formData.company, formData.towType);
      const route = routes.find(r => r.from === formData.from && r.to === formData.to);
      
      if (!route) {
        document.getElementById('towResultSection').classList.add('hidden');
        return;
      }
      
      let companyPrice = parseFloat(route.price) || 0;
      
      let extraCharges = 0;
      
      if (formData.towType === 'normal') {
        // For normal tow Ø¨ÙˆØ±ØªØ±Ø§Ø¬
        extraCharges = (formData.companyArabic === 'Ø¨ÙˆØ±ØªØ±Ø§Ø¬' && formData.extraCharges === 'yes') ? 10 : 0;
      } else if (formData.towType === 'flatbed') {
        if (formData.companyArabic === 'Ø¨ÙˆØ±ØªØ±Ø§Ø¬') {
          // For flatbed Ø¨ÙˆØ±ØªØ±Ø§Ø¬ - use flatbedPortarageExtraCharges
          extraCharges = (formData.flatbedPortarageExtraCharges === 'yes') ? 10 : 0;
        } else {
          // For flatbed other companies - no charges
          extraCharges = 0;
        }
      }
      
      const lockedCharge = (formData.towType === 'flatbed' && formData.isLocked) ? 5 : 0;
      
      let portaragePrice = companyPrice;
      let discount = 0;
      
      if (formData.company.toLowerCase() !== 'portarage towtruk') {
        const portarageRoutes = getTowRoutes('portarage towtruk', formData.towType);
        const portarageRoute = portarageRoutes.find(r => r.from === formData.from && r.to === formData.to);
        
        if (portarageRoute) {
          portaragePrice = parseFloat(portarageRoute.price) || 0;
          discount = portaragePrice - companyPrice;
        }
      }
      
      const tbody = document.getElementById('towResultBody');
      let rows = '';
      
      if (formData.company.toLowerCase() !== 'portarage towtruk') {
        const finalPrice = companyPrice + extraCharges + lockedCharge;
        
        rows = `
          <tr>
            <td>Ø³Ø¹Ø± ${formData.companyArabic}</td>
            <td class="highlight">${companyPrice.toFixed(2)} ${config.currency}</td>
          </tr>
          <tr>
            <td>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ (Ø¨ÙˆØ±ØªØ±Ø§Ø¬)</td>
            <td>${portaragePrice.toFixed(2)} ${config.currency}</td>
          </tr>
          <tr style="background: #1a4a2a;">
            <td><strong>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ…</strong></td>
            <td class="highlight" style="color: #10b981;"><strong>${discount.toFixed(2)} ${config.currency}</strong></td>
          </tr>
        `;
        
        if (lockedCharge > 0 || extraCharges > 0) {
          if (lockedCharge > 0) {
            rows += `
              <tr>
                <td>Ø¥Ø¶Ø§ÙØ© ÙˆÙ†Ø´ Ù…Ø³ÙƒØ±</td>
                <td class="highlight">${lockedCharge.toFixed(2)} ${config.currency}</td>
              </tr>
            `;
          }
          if (extraCharges > 0) {
            rows += `
              <tr>
                <td>Ø±Ø³ÙˆÙ… Ø¹Ø±Ø¨Ø§Ù†Ø§Øª (Ø§Ù„Ù‚ÙŠØ± Ù„Ø§ ÙŠØ¹Ù…Ù„)</td>
                <td class="highlight">${extraCharges.toFixed(2)} ${config.currency}</td>
              </tr>
            `;
          }
          rows += `
            <tr style="background: #262626;">
              <td><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</strong></td>
              <td class="highlight"><strong>${finalPrice.toFixed(2)} ${config.currency}</strong></td>
            </tr>
          `;
        }
      } else {
        rows = `
          <tr>
            <td>Ø³Ø¹Ø± Ø¨ÙˆØ±ØªØ±Ø§Ø¬ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</td>
            <td class="highlight">${companyPrice.toFixed(2)} ${config.currency}</td>
          </tr>
        `;
        
        if (lockedCharge > 0 || extraCharges > 0) {
          if (lockedCharge > 0) {
            rows += `
              <tr>
                <td>Ø¥Ø¶Ø§ÙØ© ÙˆÙ†Ø´ Ù…Ø³ÙƒØ±</td>
                <td class="highlight">${lockedCharge.toFixed(2)} ${config.currency}</td>
              </tr>
            `;
          }
          if (extraCharges > 0) {
            rows += `
              <tr>
                <td>Ø±Ø³ÙˆÙ… Ø¹Ø±Ø¨Ø§Ù†Ø§Øª (Ø§Ù„Ù‚ÙŠØ± Ù„Ø§ ÙŠØ¹Ù…Ù„)</td>
                <td class="highlight">${extraCharges.toFixed(2)} ${config.currency}</td>
              </tr>
            `;
          }
          const total = companyPrice + lockedCharge + extraCharges;
          rows += `
            <tr style="background: #262626;">
              <td><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</strong></td>
              <td class="highlight"><strong>${total.toFixed(2)} ${config.currency}</strong></td>
            </tr>
          `;
        }
        
        const cancelPrice = getCancellationPrice(formData.from, formData.to, formData.towType);
        if (cancelPrice) {
          rows += `
            <tr>
              <td>Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡</td>
              <td>${cancelPrice}</td>
            </tr>
          `;
        }
      }
      
      tbody.innerHTML = rows;
      document.getElementById('towResultSection').classList.remove('hidden');
      
      setTimeout(() => {
        const resultSection = document.getElementById('towResultSection');
        if (resultSection) {
          resultSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      }, 100);
    }
    
    function getCancellationPrice(from, to, towType) {
      const rows = sheetsData['portarage towtruk'];
      if (!rows || rows.length < 3) return null;
      
      for (let i = 2; i < rows.length; i++) {
        const row = rows[i];
        
        if (towType === 'normal') {
          if (row[6] === from && row[5] === to && row[3]) {
            return `${parseFloat(row[3]).toFixed(2)} ${config.currency}`;
          }
          if (row[6] === from && row[2] === to && row[0]) {
            return `${parseFloat(row[0]).toFixed(2)} ${config.currency}`;
          }
        } else if (towType === 'flatbed') {
          if (row[14] === from && row[13] === to && row[11]) {
            return `${parseFloat(row[11]).toFixed(2)} ${config.currency}`;
          }
          if (row[14] === from && row[10] === to && row[8]) {
            return `${parseFloat(row[8]).toFixed(2)} ${config.currency}`;
          }
        }
      }
      
      return null;
    }

    // Render Battery Install Interface
    function renderBatteryInstallInterface() {
      const contentArea = document.getElementById('contentArea');
      contentArea.innerHTML = `
        <div class="form-section full-width">
          <h3 class="section-title">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</h3>
          <div class="form-field">
            <input type="text" list="areaOptions" id="areaSelect" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø£Ùˆ Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©">
            <datalist id="areaOptions"></datalist>
          </div>
          <div class="info-box">Ø¨Ø·Ø§Ø±ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ - Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¹Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
        </div>
        
        <div id="serviceResultSection" class="data-table-container hidden">
          <div class="table-header">ØªØ±ÙƒÙŠØ¨ Ø¨Ø·Ø§Ø±ÙŠØ©</div>
          <div class="table-scroll">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Ø§Ù„Ø¨ÙŠØ§Ù†</th>
                  <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                </tr>
              </thead>
              <tbody id="serviceResultBody">
              </tbody>
            </table>
          </div>
        </div>
      `;
      
      loadBatteryInstallOptions();
    }
    
    function loadBatteryInstallOptions() {
      const areaSelect = document.getElementById('areaSelect');
      const areaDatalist = document.getElementById('areaOptions');
      
      if (!sheetsData['ØªØ±ÙƒÙŠØ¨ Ø¨Ø·Ø§Ø±ÙŠØ©']) {
        areaDatalist.innerHTML = '<option value="">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</option>';
        return;
      }
      
      const rows = sheetsData['ØªØ±ÙƒÙŠØ¨ Ø¨Ø·Ø§Ø±ÙŠØ©'];
      const areas = [];
      
      for (let i = 2; i < rows.length; i++) {
        const row = rows[i];
        if (row[0]) areas.push(row[0]);
        if (row[4]) areas.push(row[4]);
      }
      
      const uniqueAreas = [...new Set(areas)].filter(Boolean);
      areaDatalist.innerHTML = uniqueAreas.map(area => `<option value="${area}">${area}</option>`).join('');
      
      areaSelect.oninput = () => {
        formData.area = areaSelect.value;
        if (formData.area) {
          calculateBatteryInstallPrice();
        } else {
          document.getElementById('serviceResultSection').classList.add('hidden');
        }
      };
    }
    
    function calculateBatteryInstallPrice() {
      const rows = sheetsData['ØªØ±ÙƒÙŠØ¨ Ø¨Ø·Ø§Ø±ÙŠØ©'];
      if (!rows || !formData.area) return;
      
      let price = null;
      let cancellation = null;
      
      for (let i = 2; i < rows.length; i++) {
        const row = rows[i];
        
        if (row[0] === formData.area) {
          price = row[1];
          cancellation = row[2];
          break;
        }
        
        if (row[4] === formData.area) {
          price = row[5];
          cancellation = row[6];
          break;
        }
      }
      
      if (!price) {
        document.getElementById('serviceResultSection').classList.add('hidden');
        return;
      }
      
      const tbody = document.getElementById('serviceResultBody');
      tbody.innerHTML = `
        <tr>
          <td>Ø³Ø¹Ø± Ø§Ù„Ø®Ø¯Ù…Ø©</td>
          <td class="highlight">${parseFloat(price).toFixed(2)} ${config.currency}</td>
        </tr>
        <tr>
          <td>Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡</td>
          <td>${cancellation ? parseFloat(cancellation).toFixed(2) + ' ' + config.currency : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
        </tr>
      `;
      
      document.getElementById('serviceResultSection').classList.remove('hidden');
    }

    // Render Fuel Interface
    function renderFuelInterface() {
      const contentArea = document.getElementById('contentArea');
      contentArea.innerHTML = `
        <div class="form-section">
          <h3 class="section-title">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</h3>
          <div class="form-field">
            <input type="text" list="areaOptions" id="areaSelect" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø£Ùˆ Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©">
            <datalist id="areaOptions"></datalist>
          </div>
        </div>
        
        <div id="fuelTypeSection" class="form-section hidden">
          <h3 class="section-title">Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø²ÙŠÙ†</h3>
          <div class="btn-grid" style="grid-template-columns: repeat(3, 1fr);">
            <button class="btn-option" data-fuel="premium">Ø¨Ù†Ø²ÙŠÙ† Ù…Ù…ØªØ§Ø²<br><small>(1.5 Ø¯.Ùƒ)</small></button>
            <button class="btn-option" data-fuel="special">Ø¨Ù†Ø²ÙŠÙ† Ø®ØµÙˆØµÙŠ<br><small>(1.5 Ø¯.Ùƒ)</small></button>
            <button class="btn-option" data-fuel="ultra">Ø¨Ù†Ø²ÙŠÙ† Ø§Ù„ØªØ±Ø§<br><small>(2.5 Ø¯.Ùƒ)</small></button>
          </div>
        </div>

        <!-- (ØªÙ… Ù†Ù‚Ù„ ÙˆØ§Ø¬Ù‡Ø© ÙØªØ­ Ø§Ù„Ù‚ÙÙ„ Ø¥Ù„Ù‰ Ø®Ø¯Ù…Ø© Ù…Ù†ÙØµÙ„Ø© 'ÙØªØ­ Ù‚ÙÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø©') -->

        <div id="fuelResultSection" class="data-table-container hidden">
          <div class="table-header">Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­Ø³Ø§Ø¨</div>
          <div class="table-scroll">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Ø§Ù„Ø¨ÙŠØ§Ù†</th>
                  <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                </tr>
              </thead>
              <tbody id="fuelResultBody">
              </tbody>
            </table>
          </div>
          <div class="warning-box">
            <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ù„Ø§Ø²Ù… ØªØ´Ø±Ø­ÙˆÙ† Ù„Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù†Ù‡ Ø±Ø³ÙˆÙ… Ø§Ù„Ø®Ø¯Ù…Ù‡ Ù…Ù†ÙØµÙ„Ø© Ø¹Ù† Ø³Ø¹Ø± Ø§Ù„Ø¨Ù†Ø²ÙŠÙ† ÙˆØ§Ù„ÙƒÙ… ÙŠÙˆØµÙ„Ù‡ Ù„Ø§Ù‚Ø±Ø¨ Ù…Ø­Ø·Ù‡ ÙÙ‚Ø·
          </div>
        </div>
      `;
      
      loadAreaOptionsDatalist('Ø®Ø¯Ù…Ø§Øª5', [0, 1, 2, 4, 5, 6], () => {
        document.getElementById('fuelTypeSection').classList.remove('hidden');

        document.querySelectorAll('[data-fuel]').forEach(btn => {
          btn.onclick = () => {
            document.querySelectorAll('[data-fuel]').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            formData.fuelType = btn.dataset.fuel;
            calculateFuelPrice();
          };
        });
      });
    }

    function calculateFuelPrice() {
      const rows = sheetsData['Ø®Ø¯Ù…Ø§Øª5'];
      if (!rows || !formData.area) return;
      
      let servicePrice = 0;
      let cancellation = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      
      for (let i = 2; i < rows.length; i++) {
        const row = rows[i];
        if (row[0] === formData.area) {
          servicePrice = parseFloat(row[1]) || 0;
          cancellation = row[2] ? `${parseFloat(row[2]).toFixed(2)} ${config.currency}` : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
          break;
        } else if (row[4] === formData.area) {
          servicePrice = parseFloat(row[5]) || 0;
          cancellation = row[6] ? `${parseFloat(row[6]).toFixed(2)} ${config.currency}` : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
          break;
        }
      }
      
      const fuelPrices = { 'premium': 1.5, 'special': 1.5, 'ultra': 2.5 };
      const fuelPrice = fuelPrices[formData.fuelType] || 1.5;
      const total = servicePrice + fuelPrice;
      
      const fuelNames = { 'premium': 'Ø¨Ù†Ø²ÙŠÙ† Ù…Ù…ØªØ§Ø²', 'special': 'Ø¨Ù†Ø²ÙŠÙ† Ø®ØµÙˆØµÙŠ', 'ultra': 'Ø¨Ù†Ø²ÙŠÙ† Ø§Ù„ØªØ±Ø§' };
      
      const tbody = document.getElementById('fuelResultBody');
      tbody.innerHTML = `
        <tr>
          <td>Ø±Ø³ÙˆÙ… Ø®Ø¯Ù…Ø© Ø§Ù„ØªÙˆØµÙŠÙ„</td>
          <td class="highlight">${servicePrice.toFixed(2)} ${config.currency}</td>
        </tr>
        <tr>
          <td>Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø²ÙŠÙ†</td>
          <td>${fuelNames[formData.fuelType]}</td>
        </tr>
        <tr>
          <td>Ø³Ø¹Ø± Ø§Ù„Ø¨Ù†Ø²ÙŠÙ†</td>
          <td class="highlight">${fuelPrice.toFixed(2)} ${config.currency}</td>
        </tr>
        <tr style="background: #262626;">
          <td><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</strong></td>
          <td class="highlight"><strong>${total.toFixed(2)} ${config.currency}</strong></td>
        </tr>
        <tr>
          <td>Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡</td>
          <td>${cancellation}</td>
        </tr>
      `;
      
      document.getElementById('fuelResultSection').classList.remove('hidden');
    }

    // Calculate price for ÙØªØ­ Ù‚ÙÙ„ when performed by Ø¨ÙˆØ±ØªØ±Ø§Ø¬
    function calculateLockPortaragePrice() {
      const rows = sheetsData['ÙØªØ­ Ù‚ÙÙ„'] || sheetsData['Ø®Ø¯Ù…Ø§Øª5'];
      if (!rows || !formData.lockArea) return;

      let price = null;
      let cancellation = null;

      for (let i = 2; i < rows.length; i++) {
        const row = rows[i];

        // Read from columns Q (16), R (17), S (18)
        if (row[16] === formData.lockArea) {
          price = parseFloat(row[17]) || 0;
          cancellation = row[18] ? `${parseFloat(row[18]).toFixed(2)} ${config.currency}` : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
          break;
        }

        // Read from columns U (20), V (21), W (22)
        if (row[20] === formData.lockArea) {
          price = parseFloat(row[21]) || 0;
          cancellation = row[22] ? `${parseFloat(row[22]).toFixed(2)} ${config.currency}` : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
          break;
        }
      }

      const body = document.getElementById('lockPortarageBody');
      const result = document.getElementById('lockPortarageResult');
      const finalNotice = document.getElementById('lockFinalNotice');

      if (price === null) {
        result.classList.add('hidden');
        return;
      }

      // Ù„Ø¨ÙˆØ±ØªØ±Ø§Ø¬: Ù„Ø§ Ù†Ø¶ÙŠÙ Ø£ÙŠ Ø²ÙŠØ§Ø¯Ø©ØŒ Ø§Ù„Ø³Ø¹Ø± ÙƒÙ…Ø§ Ù‡Ùˆ Ù…Ù† Ø§Ù„Ø´ÙŠØª
      const finalPrice = price;

      body.innerHTML = `
        <tr>
          <td>Ø³Ø¹Ø± ÙØªØ­ Ø§Ù„Ù‚ÙÙ„ (Ø¨ÙˆØ±ØªØ±Ø§Ø¬)</td>
          <td class="highlight">${price.toFixed(2)} ${config.currency}</td>
        </tr>
        <tr>
          <td>Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡</td>
          <td>${cancellation}</td>
        </tr>
        <tr style="background: #262626;">
          <td><strong>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</strong></td>
          <td class="highlight"><strong>${finalPrice.toFixed(2)} ${config.currency}</strong></td>
        </tr>
      `;

      result.classList.remove('hidden');
      // Ù„Ø¨ÙˆØ±ØªØ±Ø§Ø¬: Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø£Ø²Ø±Ù‚ ÙˆÙÙ‚ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    }

    // Calculate price for ÙØªØ­ Ù‚ÙÙ„ when performed by Ù…ÙˆØ±Ø¯ Ø®Ø§Ø±Ø¬ÙŠ
    function calculateLockExternalPrice(externalPrice) {
      const rows = sheetsData['ÙØªØ­ Ù‚ÙÙ„'] || sheetsData['Ø®Ø¯Ù…Ø§Øª5'];
      const externalBody = document.getElementById('lockExternalBody');
      const externalResult = document.getElementById('lockExternalResult');
      const finalNotice = document.getElementById('lockFinalNotice');
      const externalNoteDisplay = document.getElementById('lockExternalNoteDisplay');

      if (!rows) return;

      // apply fixed surcharge for external as well
      const finalPrice = (externalPrice || 0) + LOCK_SURCHARGE;

      externalBody.innerHTML = `
        <tr>
          <td>Ø³Ø¹Ø± Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ</td>
          <td class="highlight">${(externalPrice||0).toFixed(2)} ${config.currency}</td>
        </tr>
        <tr style="background: #262626;">
          <td><strong>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</strong></td>
          <td class="highlight"><strong>${finalPrice.toFixed(2)} ${config.currency}</strong></td>
        </tr>
      `;

      externalResult.classList.remove('hidden');
      // show final notice and external note
      if (finalNotice) {
        finalNotice.classList.remove('hidden');
        finalNotice.textContent = `Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø°ÙŠ ÙŠØªÙ… Ø§Ø¨Ù„Ø§Øº Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙÙŠÙ‡ Ù…Ø¹ Ø§Ù„Ø²ÙŠØ§Ø¯Ø© : ${finalPrice.toFixed(2)} ${config.currency}`;
      }
      if (externalNoteDisplay) externalNoteDisplay.classList.remove('hidden');
    }

    // Apply surcharge string from sheet first row column I.
    // surchargeRaw can be '10%' or '2.5' (absolute). Returns numeric final price.
    function applySurcharge(basePrice, surchargeRaw) {
      if (!surchargeRaw) return basePrice;
      const s = surchargeRaw.toString().trim();
      if (s.endsWith('%')) {
        const p = parseFloat(s.replace('%', '')) || 0;
        return basePrice + (basePrice * p / 100);
      }
      const absolute = parseFloat(s);
      if (isNaN(absolute)) return basePrice;
      // If value looks like a percentage number (e.g. 10) treat as percent (10 -> 10%)
      if (absolute >= 1 && absolute <= 100) {
        return basePrice + (basePrice * absolute / 100);
      }
      // otherwise treat as absolute amount
      return basePrice + absolute;
    }

    // Render Puncture Service (Ø¨Ù†Ø´Ø±)
    function renderPunctureService() {
      const contentArea = document.getElementById('contentArea');
      contentArea.innerHTML = `
        <div class="form-section full-width">
          <h3 class="section-title">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</h3>
          <div class="form-field">
            <input type="text" list="areaOptions" id="areaSelect" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø£Ùˆ Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©">
            <datalist id="areaOptions"></datalist>
          </div>
          <div class="info-box">
            <strong>âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ Ù…Ù‡Ù…:</strong><br>
            â€¢ <strong>Ø±Ù‚Ø¹Ø© Ø®Ø§Ø±Ø¬ÙŠØ© / Ø³Ø¨ÙŠØ± / ØªØ¹Ø¨Ø¦Ø© Ù‡ÙˆØ§Ø¡:</strong> Ø£ÙŠ ÙÙ†ÙŠ + Ø¨Ø§Øµ Ø§Ù„ØªÙˆØ§ÙŠØ±<br>
            â€¢ <strong>Ø±Ù‚Ø¹Ø© Ø¯Ø§Ø®Ù„ÙŠØ©:</strong> ÙÙ‚Ø· Ø¨Ø§Øµ Ø§Ù„ØªÙˆØ§ÙŠØ±
          </div>
        </div>
        
        <div id="tireResultSection" class="data-table-container hidden">
          <div class="table-header">Ø£Ø³Ø¹Ø§Ø± Ø®Ø¯Ù…Ø© Ø§Ù„Ø¨Ù†Ø´Ø±</div>
          <div class="table-scroll">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©</th>
                  <th>Ø§Ù„Ø³Ø¹Ø±</th>
                  <th>Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡</th>
                </tr>
              </thead>
              <tbody id="tireResultBody">
              </tbody>
            </table>
          </div>
        </div>
      `;
      
      loadAreaOptionsDatalist('Ø®Ø¯Ù…Ø§Øª5', [0, 1, 2, 4, 5, 6, 8, 9, 10, 12, 13, 14], () => {
        calculatePuncturePrice();
      });
    }

    // Render Unlock (ÙØªØ­ Ù‚ÙÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø©) as a separate service
    function renderLockInterface() {
      const contentArea = document.getElementById('contentArea');
      contentArea.innerHTML = `
        <div class="form-section">
          <h3 class="section-title">ÙØªØ­ Ù‚ÙÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø© ğŸ”“</h3>
          <div class="form-field">
            <label>Ù…Ù† Ø³ÙŠÙ‚ÙˆÙ… Ø¨Ø§Ù„Ø®Ø¯Ù…Ø©ØŸ</label>
            <div class="btn-grid" style="grid-template-columns: repeat(2,1fr);">
              <button class="btn-option" id="lockProviderPortarage" data-lock-provider="Ø¨ÙˆØ±ØªØ±Ø§Ø¬">Ø¨ÙˆØ±ØªØ±Ø§Ø¬</button>
              <button class="btn-option" id="lockProviderExternal" data-lock-provider="Ù…ÙˆØ±Ø¯ Ø®Ø§Ø±Ø¬ÙŠ">Ù…ÙˆØ±Ø¯ Ø®Ø§Ø±Ø¬ÙŠ</button>
            </div>
          </div>

          <div id="lockPortaragePanel" class="form-section hidden" style="margin-top:8px;">
            <div class="form-field">
              <label>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
              <input type="text" list="areaOptions" id="lockAreaSelect" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø£Ùˆ Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©">
              <datalist id="areaOptions"></datalist>
            </div>
            <div id="lockPortarageResult" class="data-table-container hidden">
              <div class="table-header">Ù†ØªÙŠØ¬Ø© ÙØªØ­ Ø§Ù„Ù‚ÙÙ„ - Ø¨ÙˆØ±ØªØ±Ø§Ø¬</div>
              <div class="table-scroll"><table class="data-table"><thead><tr><th>Ø§Ù„Ø¨ÙŠØ§Ù†</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th></tr></thead><tbody id="lockPortarageBody"></tbody></table></div>
            </div>
            <div class="warning-box" style="margin-top:8px;">ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙÙ†ÙŠ Ø¨ÙˆØ±ØªØ±Ø§Ø¬ Ø§Ù†Ù‡ ÙŠÙ‚Ø¯Ø± ÙŠÙØªØ­ Ø¨Ø§Ø¨ Ø§Ù„Ø³ÙŠØ§Ø±Ù‡ Ù„Ù†Ù‡ Ù…Ø§Ø¹Ù†Ø¯Ù†Ø§ Ø§Ù…ÙƒØ§Ù†ÙŠÙ‡ Ù†ÙØªØ­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</div>
          </div>

          <div id="lockExternalPanel" class="form-section hidden" style="margin-top:8px;">
            <div class="form-field">
              <label>Ø³Ø¹Ø± Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ</label>
              <input type="number" id="lockExternalPrice" class="form-control" placeholder="Ø¶Ø¹ Ø³Ø¹Ø± Ø§Ù„ÙÙ†ÙŠ Ù‡Ù†Ø§">
            </div>
            <div id="lockExternalNoteDisplay" class="info-box" style="margin-top:8px;">Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ù„ÙÙ†ÙŠÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠÙ† â€” Ù‚Ø±ÙˆØ¨ Ø¹Ø«Ù…Ø§Ù† â€¢ Mr.LOCK</div>
            <div id="lockExternalResult" class="data-table-container hidden"><div class="table-header">Ù†ØªÙŠØ¬Ø© ÙØªØ­ Ø§Ù„Ù‚ÙÙ„ - Ù…ÙˆØ±Ø¯ Ø®Ø§Ø±Ø¬ÙŠ</div><div class="table-scroll"><table class="data-table"><thead><tr><th>Ø§Ù„Ø¨ÙŠØ§Ù†</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th></tr></thead><tbody id="lockExternalBody"></tbody></table></div></div>
          </div>

          <div id="lockFinalNotice" class="info-box hidden" style="margin-top:8px;"></div>
        </div>
      `;
      // populate area options for this service from sheet 'ÙØªØ­ Ù‚ÙÙ„'
      loadLockAreaOptionsDatalist();

      // wire up buttons
      document.getElementById('lockProviderPortarage').onclick = () => {
        document.getElementById('lockProviderPortarage').classList.add('active');
        document.getElementById('lockProviderExternal').classList.remove('active');
        document.getElementById('lockPortaragePanel').classList.remove('hidden');
        document.getElementById('lockExternalPanel').classList.add('hidden');
        document.getElementById('lockFinalNotice').classList.add('hidden');
      };

      document.getElementById('lockProviderExternal').onclick = () => {
        document.getElementById('lockProviderExternal').classList.add('active');
        document.getElementById('lockProviderPortarage').classList.remove('active');
        document.getElementById('lockExternalPanel').classList.remove('hidden');
        document.getElementById('lockPortaragePanel').classList.add('hidden');
        document.getElementById('lockFinalNotice').classList.add('hidden');
      };

      // when area selected
      const lockAreaSelect = document.getElementById('lockAreaSelect');
      lockAreaSelect.oninput = () => {
        formData.lockArea = lockAreaSelect.value.trim();
        if (!formData.lockArea) {
          document.getElementById('lockPortarageResult').classList.add('hidden');
          return;
        }
        calculateLockPortaragePrice();
      };

      // external price
      const lockExternalPrice = document.getElementById('lockExternalPrice');
      // update immediately on input/change/keyup
      if (lockExternalPrice) {
        ['input', 'change', 'keyup'].forEach(evt => {
          lockExternalPrice.addEventListener(evt, () => {
            const val = parseFloat(lockExternalPrice.value);
            calculateLockExternalPrice(isNaN(val) ? 0 : val);
            const note = document.getElementById('lockExternalNoteDisplay');
            if (note) note.style.display = 'block';
          });
        });
      }
    }

    // Load datalist options specifically for ÙØªØ­ Ù‚ÙÙ„ sheet
    function loadLockAreaOptionsDatalist() {
      const areaSelect = document.getElementById('lockAreaSelect');
      const areaDatalist = document.getElementById('areaOptions');
      const rows = sheetsData['ÙØªØ­ Ù‚ÙÙ„'] || sheetsData['Ø®Ø¯Ù…Ø§Øª5'];
      if (!rows) {
        areaDatalist.innerHTML = '<option value="">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</option>';
        return;
      }

      const areas = [];
      for (let i = 2; i < rows.length; i++) {
        const row = rows[i];
        // Read from column Q (16) and U (20)
        if (row[16]) areas.push(row[16]);
        if (row[20]) areas.push(row[20]);
      }

      const uniqueAreas = [...new Set(areas)].filter(Boolean);
      areaDatalist.innerHTML = uniqueAreas.map(area => `<option value="${area}">${area}</option>`).join('');
      
      // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« onfocus Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
      areaSelect.onfocus = function() {
        if (this.value === '') {
          this.dispatchEvent(new Event('input', { bubbles: true }));
          this.click();
        }
      };
    }

    function calculatePuncturePrice() {
      const rows = sheetsData['Ø®Ø¯Ù…Ø§Øª5'];
      if (!rows) return;
      
      let externalPrice = 'ØºÙŠØ± Ù…ØªÙˆÙØ±', externalCancel = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      let internalPrice = 'ØºÙŠØ± Ù…ØªÙˆÙØ±', internalCancel = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      
      for (let i = 2; i < rows.length; i++) {
        const row = rows[i];
        
        if (row[0] === formData.area) {
          externalPrice = row[1] ? `${parseFloat(row[1]).toFixed(2)} ${config.currency}` : 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
          externalCancel = row[2] ? `${parseFloat(row[2]).toFixed(2)} ${config.currency}` : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        } else if (row[4] === formData.area) {
          externalPrice = row[5] ? `${parseFloat(row[5]).toFixed(2)} ${config.currency}` : 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
          externalCancel = row[6] ? `${parseFloat(row[6]).toFixed(2)} ${config.currency}` : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        }
        
        if (row[8] === formData.area) {
          internalPrice = row[9] ? `${parseFloat(row[9]).toFixed(2)} ${config.currency}` : 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
          internalCancel = row[10] ? `${parseFloat(row[10]).toFixed(2)} ${config.currency}` : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        } else if (row[12] === formData.area) {
          internalPrice = row[13] ? `${parseFloat(row[13]).toFixed(2)} ${config.currency}` : 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
          internalCancel = row[14] ? `${parseFloat(row[14]).toFixed(2)} ${config.currency}` : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        }
      }
      
      const tbody = document.getElementById('tireResultBody');
      tbody.innerHTML = `
        <tr>
          <td>Ø±Ù‚Ø¹Ø© Ø®Ø§Ø±Ø¬ÙŠØ© / ØªØ±ÙƒÙŠØ¨ Ø³Ø¨ÙŠØ± / ØªØ¹Ø¨Ø¦Ø© Ù‡ÙˆØ§Ø¡</td>
          <td class="highlight">${externalPrice}</td>
          <td>${externalCancel}</td>
        </tr>
        <tr>
          <td>Ø±Ù‚Ø¹Ø© Ø¯Ø§Ø®Ù„ÙŠØ©</td>
          <td class="highlight">${internalPrice}</td>
          <td>${internalCancel}</td>
        </tr>
      `;
      
      document.getElementById('tireResultSection').classList.remove('hidden');
    }

    // Render Balance Service (Ù…ÙŠØ²Ø§Ù† ÙˆØªØ±ÙƒÙŠØ¨)
    function renderBalanceService() {
      const contentArea = document.getElementById('contentArea');
      contentArea.innerHTML = `
        <div class="form-section">
          <h3 class="section-title">Ù…ØµØ¯Ø± Ø§Ù„ØªÙˆØ§ÙŠØ±</h3>
          <div class="btn-grid" style="grid-template-columns: repeat(2, 1fr);">
            <button class="btn-option" data-source="customer">Ù…Ù† Ø¹Ù†Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
            <button class="btn-option" data-source="ours">Ù…Ù† Ø¹Ù†Ø¯Ù†Ø§</button>
          </div>
        </div>
        
        <div id="balanceAreaSection" class="form-section hidden">
          <h3 class="section-title">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</h3>
          <div class="form-field">
            <input type="text" list="areaOptions" id="areaSelect" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø£Ùˆ Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©">
            <datalist id="areaOptions"></datalist>
          </div>
        </div>
        
        <div id="tireCountSection" class="form-section hidden">
          <h3 class="section-title">Ø¹Ø¯Ø¯ Ø§Ù„ØªÙˆØ§ÙŠØ±</h3>
          <div class="form-field">
            <input type="number" id="tireCountInput" class="form-control" min="1" max="10" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„ØªÙˆØ§ÙŠØ±">
          </div>
        </div>
        
        <div id="balanceResultSection" class="data-table-container hidden">
          <div class="table-header">Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­Ø³Ø§Ø¨</div>
          <div class="table-scroll">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Ø§Ù„Ø¨ÙŠØ§Ù†</th>
                  <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                </tr>
              </thead>
              <tbody id="balanceResultBody">
              </tbody>
            </table>
          </div>
          <div id="balanceNote" class="info-box hidden"></div>
        </div>
      `;
      
      document.querySelectorAll('[data-source]').forEach(btn => {
        btn.onclick = () => {
          document.querySelectorAll('[data-source]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          
          formData.tireSource = btn.dataset.source;
          
          // Hide all sections first
          document.getElementById('balanceResultSection').classList.add('hidden');
          document.getElementById('balanceAreaSection').classList.add('hidden');
          document.getElementById('tireCountSection').classList.add('hidden');
          document.getElementById('areaSelect').value = '';
          formData.area = null;
          
          // Show area section
          document.getElementById('balanceAreaSection').classList.remove('hidden');
          
          if (formData.tireSource === 'ours') {
            document.getElementById('tireCountSection').classList.add('hidden');
            loadAreaOptionsDatalist('Ù…ÙŠØ²Ø§Ù† ÙˆØªØ±ÙƒÙŠØ¨', [0, 1, 2, 4, 5, 6], calculateBalancePrice);
          } else {
            document.getElementById('tireCountSection').classList.remove('hidden');
            loadAreaOptionsDatalist('Ù…ÙŠØ²Ø§Ù† ÙˆØªØ±ÙƒÙŠØ¨', [8, 9, 10, 12, 13, 14], () => {
              const tireCountInput = document.getElementById('tireCountInput');
              tireCountInput.oninput = (e) => {
                formData.tireCount = parseInt(e.target.value) || 0;
                if (formData.tireCount > 0 && formData.area) calculateBalancePrice();
              };
            });
          }
        };
      });
    }

    function calculateBalancePrice() {
      if (!formData.area) return;
      
      const rows = sheetsData['Ù…ÙŠØ²Ø§Ù† ÙˆØªØ±ÙƒÙŠØ¨'];
      if (!rows) return;
      
      let basePrice = 0;
      let cancellation = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      
      if (formData.tireSource === 'ours') {
        for (let i = 2; i < rows.length; i++) {
          const row = rows[i];
          if (row[0] === formData.area) {
            basePrice = parseFloat(row[1]) || 0;
            cancellation = row[2] ? `${parseFloat(row[2]).toFixed(2)} ${config.currency}` : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            break;
          } else if (row[4] === formData.area) {
            basePrice = parseFloat(row[5]) || 0;
            cancellation = row[6] ? `${parseFloat(row[6]).toFixed(2)} ${config.currency}` : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            break;
          }
        }
        
        const tbody = document.getElementById('balanceResultBody');
        tbody.innerHTML = `
          <tr>
            <td>Ø³Ø¹Ø± Ø§Ù„Ø®Ø¯Ù…Ø©</td>
            <td class="highlight">${basePrice.toFixed(2)} ${config.currency}</td>
          </tr>
          <tr>
            <td>Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡</td>
            <td>${cancellation}</td>
          </tr>
        `;
        
        const noteDiv = document.getElementById('balanceNote');
        noteDiv.textContent = 'Ø§Ù„Ø³Ø¹Ø± Ù‡Ø°Ø§ Ø³ÙˆØ§Ø¡ Ø¨Ù†Ø±ÙƒØ¨ Ù…Ù† ØªØ§ÙŠØ± Ø§Ù„Ù‰ Ø§Ø±Ø¨Ø¹ ØªÙˆØ§ÙŠØ± Ù†ÙØ³ Ø±Ø³ÙˆÙ… Ø§Ù„Ø®Ø¯Ù…Ù‡';
        noteDiv.classList.remove('hidden');
        
      } else {
        for (let i = 2; i < rows.length; i++) {
          const row = rows[i];
          if (row[8] === formData.area) {
            basePrice = parseFloat(row[9]) || 0;
            cancellation = row[10] ? `${parseFloat(row[10]).toFixed(2)} ${config.currency}` : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            break;
          } else if (row[12] === formData.area) {
            basePrice = parseFloat(row[13]) || 0;
            cancellation = row[14] ? `${parseFloat(row[14]).toFixed(2)} ${config.currency}` : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            break;
          }
        }
        
        const tireCount = formData.tireCount || 0;
        const total = basePrice + (tireCount * 5);
        
        const tbody = document.getElementById('balanceResultBody');
        tbody.innerHTML = `
          <tr>
            <td>Ø³Ø¹Ø± Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</td>
            <td class="highlight">${basePrice.toFixed(2)} ${config.currency}</td>
          </tr>
          <tr>
            <td>Ø¹Ø¯Ø¯ Ø§Ù„ØªÙˆØ§ÙŠØ±</td>
            <td>${tireCount}</td>
          </tr>
          <tr>
            <td>Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙˆØ§ÙŠØ± (5 Ø¯.Ùƒ Ã— ${tireCount})</td>
            <td class="highlight">${(tireCount * 5).toFixed(2)} ${config.currency}</td>
          </tr>
          <tr style="background: #262626;">
            <td><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</strong></td>
            <td class="highlight"><strong>${total.toFixed(2)} ${config.currency}</strong></td>
          </tr>
          <tr>
            <td>Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡</td>
            <td>${cancellation}</td>
          </tr>
        `;
        
        const noteDiv = document.getElementById('balanceNote');
        noteDiv.textContent = 'Ø¥Ø°Ø§ Ø§Ù„ØªÙˆØ§ÙŠØ± Ù…Ù† Ø¹Ù†Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„';
        noteDiv.classList.remove('hidden');
      }
      
      document.getElementById('balanceResultSection').classList.remove('hidden');
    }

    // Render Mechanical Interface - UPDATED: Ø²ÙŠØª ÙˆÙÙ„ØªØ± ÙƒØ®ÙŠØ§Ø±
    function renderMechanicalInterface() {
      const contentArea = document.getElementById('contentArea');
      contentArea.innerHTML = `
        <div class="form-section">
          <h3 class="section-title">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©</h3>
          <div class="btn-grid" style="grid-template-columns: repeat(3, 1fr);">
            <button class="btn-option" data-mech="inspection">ÙØ­Øµ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</button>
            <button class="btn-option" data-mech="brakes">Ø³ÙØ§ÙŠÙ ÙˆØ¯ÙŠØ³ÙƒØ§Øª</button>
            <button class="btn-option" data-mech="oilfilter">Ø²ÙŠØª ÙˆÙÙ„ØªØ±</button>
          </div>
        </div>
        
        <div id="oilFilterSourceSection" class="form-section hidden">
          <h3 class="section-title">Ù…ØµØ¯Ø± Ø§Ù„Ø²ÙŠØª</h3>
          <div class="btn-grid" style="grid-template-columns: repeat(2, 1fr);">
            <button class="btn-option" data-oil-source="customer">Ù…Ù† Ø¹Ù†Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
            <button class="btn-option" data-oil-source="ours">Ù…Ù† Ø¹Ù†Ø¯Ù†Ø§</button>
          </div>
        </div>
        
        <div id="mechAreaSection" class="form-section hidden">
          <h3 class="section-title">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</h3>
          <div class="form-field">
            <input type="text" list="areaOptions" id="areaSelect" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø£Ùˆ Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©">
            <datalist id="areaOptions"></datalist>
          </div>
        </div>
        
        <div id="diskTurningSection" class="form-section hidden">
          <h3 class="section-title">Ù…Ø®Ø±Ø·Ø© Ø¯ÙŠØ³ÙƒØ§Øª</h3>
          <div class="btn-grid" style="grid-template-columns: 1fr 1fr;">
            <button class="btn-option active" data-disk="no">Ù„Ø§</button>
            <button class="btn-option" data-disk="yes">Ù†Ø¹Ù… (+5 Ø¯.Ùƒ)</button>
          </div>
        </div>
        
        <div id="mechResultSection" class="data-table-container hidden">
          <div class="table-header">Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­Ø³Ø§Ø¨</div>
          <div class="table-scroll">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Ø§Ù„Ø¨ÙŠØ§Ù†</th>
                  <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                </tr>
              </thead>
              <tbody id="mechResultBody">
              </tbody>
            </table>
          </div>
          <div id="mechNote" class="info-box hidden"></div>
        </div>
      `;
      
      document.querySelectorAll('[data-mech]').forEach(btn => {
        btn.onclick = () => {
          document.querySelectorAll('[data-mech]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          
          formData.mechanicalService = btn.dataset.mech;
          
          document.getElementById('mechResultSection').classList.add('hidden');
          document.getElementById('areaSelect').value = '';
          formData.area = null;
          
          // Hide all dynamic sections
          document.getElementById('oilFilterSourceSection').classList.add('hidden');
          document.getElementById('mechAreaSection').classList.add('hidden');
          document.getElementById('diskTurningSection').classList.add('hidden');
          
          if (formData.mechanicalService === 'oilfilter') {
            // Show oil source selection
            document.getElementById('oilFilterSourceSection').classList.remove('hidden');
            
            document.querySelectorAll('[data-oil-source]').forEach(oilBtn => {
              oilBtn.onclick = () => {
                document.querySelectorAll('[data-oil-source]').forEach(b => b.classList.remove('active'));
                oilBtn.classList.add('active');
                
                formData.oilSource = oilBtn.dataset.oilSource;
                
                if (formData.oilSource === 'customer') {
                  // Show area selection and load data from columns 8-14
                  document.getElementById('mechAreaSection').classList.remove('hidden');
                  loadAreaOptionsDatalist('Ø®Ø¯Ù…Ø§Øª Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©', [8, 9, 10, 12, 13, 14], calculateMechanicalPrice);
                } else if (formData.oilSource === 'ours') {
                  // Open external oil website
                  openFullscreenIframe('https://portarageoils.netlify.app/', 'Ø²ÙŠØª ÙˆÙÙ„ØªØ±');
                }
              };
            });
            
          } else if (formData.mechanicalService === 'inspection') {
            document.getElementById('diskTurningSection').classList.add('hidden');
            document.getElementById('mechAreaSection').classList.remove('hidden');
            loadAreaOptionsDatalist('Ø®Ø¯Ù…Ø§Øª Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©', [0, 1, 2, 4, 5, 6], calculateMechanicalPrice);
          } else if (formData.mechanicalService === 'brakes') {
            document.getElementById('diskTurningSection').classList.remove('hidden');
            document.getElementById('mechAreaSection').classList.remove('hidden');
            formData.diskTurning = 'no';
            
            document.querySelectorAll('[data-disk]').forEach(diskBtn => {
              diskBtn.onclick = () => {
                document.querySelectorAll('[data-disk]').forEach(b => b.classList.remove('active'));
                diskBtn.classList.add('active');
                
                formData.diskTurning = diskBtn.dataset.disk;
                if (formData.area) calculateMechanicalPrice();
              };
            });
            
            loadAreaOptionsDatalist('Ø®Ø¯Ù…Ø§Øª Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©', [16, 17, 18, 20, 21, 22], calculateMechanicalPrice);
          }
        };
      });
    }

    function calculateMechanicalPrice() {
      if (!formData.area) return;
      
      const rows = sheetsData['Ø®Ø¯Ù…Ø§Øª Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©'];
      if (!rows) return;
      
      let columns;
      if (formData.mechanicalService === 'inspection') {
        columns = [0, 1, 2, 4, 5, 6];
      } else if (formData.mechanicalService === 'brakes') {
        columns = [16, 17, 18, 20, 21, 22];
      } else if (formData.mechanicalService === 'oilfilter' && formData.oilSource === 'customer') {
        columns = [8, 9, 10, 12, 13, 14];
      }
      
      let basePrice = 0;
      let cancellation = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      
      for (let i = 2; i < rows.length; i++) {
        const row = rows[i];
        if (row[columns[0]] === formData.area) {
          basePrice = parseFloat(row[columns[1]]) || 0;
          cancellation = row[columns[2]] ? `${parseFloat(row[columns[2]]).toFixed(2)} ${config.currency}` : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
          break;
        } else if (row[columns[3]] === formData.area) {
          basePrice = parseFloat(row[columns[4]]) || 0;
          cancellation = row[columns[5]] ? `${parseFloat(row[columns[5]]).toFixed(2)} ${config.currency}` : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
          break;
        }
      }
      
      const tbody = document.getElementById('mechResultBody');
      const noteDiv = document.getElementById('mechNote');
      
      if (formData.mechanicalService === 'brakes' && formData.diskTurning === 'yes') {
        const total = basePrice + 5;
        
        tbody.innerHTML = `
          <tr>
            <td>Ø³Ø¹Ø± Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</td>
            <td class="highlight">${basePrice.toFixed(2)} ${config.currency}</td>
          </tr>
          <tr>
            <td>Ù…Ø®Ø±Ø·Ø© Ø¯ÙŠØ³ÙƒØ§Øª</td>
            <td class="highlight">5.00 ${config.currency}</td>
          </tr>
          <tr style="background: #262626;">
            <td><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</strong></td>
            <td class="highlight"><strong>${total.toFixed(2)} ${config.currency}</strong></td>
          </tr>
          <tr>
            <td>Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡</td>
            <td>${cancellation}</td>
          </tr>
        `;
        noteDiv.textContent = 'Ø¥Ø°Ø§ Ø§Ù„Ù‚Ø·Ø¹ Ù…Ù† Ø¹Ù†Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„';
        noteDiv.classList.remove('hidden');
      } else {
        tbody.innerHTML = `
          <tr>
            <td>Ø³Ø¹Ø± Ø§Ù„Ø®Ø¯Ù…Ø©</td>
            <td class="highlight">${basePrice.toFixed(2)} ${config.currency}</td>
          </tr>
          <tr>
            <td>Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡</td>
            <td>${cancellation}</td>
          </tr>
        `;
        
        if (formData.mechanicalService === 'brakes' || formData.mechanicalService === 'oilfilter') {
          noteDiv.textContent = 'Ø¥Ø°Ø§ Ø§Ù„Ù‚Ø·Ø¹ Ù…Ù† Ø¹Ù†Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„';
          noteDiv.classList.remove('hidden');
        } else {
          noteDiv.classList.add('hidden');
        }
      }
      
      document.getElementById('mechResultSection').classList.remove('hidden');
    }

    // Render Car Wash Interface
    function renderCarWashInterface() {
      const contentArea = document.getElementById('contentArea');
      contentArea.innerHTML = `
        <div class="form-section">
          <h3 class="section-title">Ù†ÙˆØ¹ Ø§Ù„ØºØ³ÙŠÙ„</h3>
          <div class="btn-grid" style="grid-template-columns: repeat(4, 1fr);">
            <button class="btn-option" data-wash="premium">ØºØ³ÙŠÙ„ Ù…Ù…ØªØ§Ø²</button>
            <button class="btn-option" data-wash="special">ØºØ³ÙŠÙ„ Ø®ØµÙˆØµÙŠ</button>
            <button class="btn-option" data-wash="ultra">ØºØ³ÙŠÙ„ Ø£Ù„ØªØ±Ø§</button>
            <button class="btn-option" data-wash="all">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</button>
          </div>
        </div>
        
        <div id="washCardsSection" class="form-section full-width hidden">
          <h3 class="section-title" style="margin-bottom: 10px;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª</h3>
          <div class="wash-cards-grid" id="washCardsGrid">
          </div>
        </div>
        
        <div id="appointmentSection" class="form-section full-width hidden">
          <h3 class="section-title">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¹Ø¯</h3>
          <div class="form-field">
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙˆØ¹Ø¯</label>
            <input type="date" id="appointmentDate" class="form-control" style="max-width: 250px;">
          </div>
          <div style="display:flex;gap:8px;">
            <button id="bookAppointmentBtn" class="btn-primary">ğŸ“… Ø­Ø¬Ø² Ø§Ù„Ù…ÙˆØ¹Ø¯</button>
            <button id="editAppointmentBtn" class="btn-primary" style="background:#666;color:#fff;">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ¹Ø¯</button>
          </div>
          <div id="availableSlots" style="margin-top: 12px;"></div>
        </div>
      `;
      
      // Book Appointment button handler â€” open Google Form directly
      document.getElementById('bookAppointmentBtn').onclick = () => {
        // Build pre-filled form URL
        let url = FORM_ACTION;
        const emptyPayload = {
          date: document.getElementById('appointmentDate').value || '',
          time: '',
          qrOrder: '',
          customerName: '',
          phone: '',
          location: '',
          washType: (formData.selectedWashes || []).join(', '),
          payment: ''
        };
        Object.keys(entryMapping).forEach(key => {
          const fieldName = entryMapping[key];
          const value = encodeURIComponent(emptyPayload[key] || '');
          url += `&${fieldName}=${value}`;
        });
        // Open the form in a new window
        window.open(url, 'googleFormWindow', 'width=800,height=600');
      };

      // Edit Appointment button handler â€” open Google Sheet
      document.getElementById('editAppointmentBtn').onclick = () => {
        window.open('https://docs.google.com/spreadsheets/d/1FkWKRxRFC8UG1Ez2VzYHadHju2HARBLbdTIsr57hKXc/edit?usp=sharing', '_blank', 'noopener,noreferrer');
      };
      
      document.querySelectorAll('[data-wash]').forEach(btn => {
        btn.onclick = () => {
          document.querySelectorAll('[data-wash]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          
          const washType = btn.dataset.wash;
          handleWashTypeSelection(washType);
        };
      });
    }

    function handleWashTypeSelection(quality) {
      const washCardsSection = document.getElementById('washCardsSection');
      const washCardsGrid = document.getElementById('washCardsGrid');
      
      if (!quality) {
        washCardsSection.classList.add('hidden');
        document.getElementById('appointmentSection').classList.add('hidden');
        return;
      }
      
      washCardsGrid.innerHTML = '';
      
      const washDetails = {
        premium: {
          name: 'â­ ØºØ³ÙŠÙ„ Ù…Ù…ØªØ§Ø²',
          duration: '1 Ø³Ø§Ø¹Ø©',
          priceSedan: 7,
          priceSUV: 8,
          services: ['ØºØ³ÙŠÙ„ Ø®Ø§Ø±Ø¬ÙŠ', 'ØªÙ†Ø¸ÙŠÙ Ø¯Ø§Ø®Ù„ÙŠ', 'ØªÙ„Ù…ÙŠØ¹ Ø§Ù„ØªÙˆØ§ÙŠØ± ÙˆØ§Ù„Ø±Ù†Ù‚Ø§Øª', 'ØªÙ†Ø¸ÙŠÙ ÙØªØ­Ø§Øª Ø§Ù„ØªÙƒÙŠÙŠÙ', 'Ø¹Ø·Ø±']
        },
        special: {
          name: 'ğŸ’ ØºØ³ÙŠÙ„ Ø®ØµÙˆØµÙŠ',
          duration: 'Ø³Ø§Ø¹ØªÙŠÙ†',
          priceSedan: 15,
          priceSUV: 17,
          services: ['ØºØ³ÙŠÙ„ Ø®Ø§Ø±Ø¬ÙŠ', 'ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ', 'ØªÙ„Ù…ÙŠØ¹ Ø¯ÙŠÙƒÙˆØ±Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©', 'Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ù‚Ø¹ Ø§Ù„Ø®ÙÙŠÙØ©', 'ØªÙ„Ù…ÙŠØ¹ Ø§Ù„ØªÙˆØ§ÙŠØ± ÙˆØ§Ù„Ø±Ù†Ù‚Ø§Øª', 'ØªÙ†Ø¸ÙŠÙ ÙØªØ­Ø§Øª Ø§Ù„ØªÙƒÙŠÙŠÙ', 'Ø¹Ø·Ø±']
        },
        ultra: {
          name: 'ğŸ‘‘ ØºØ³ÙŠÙ„ Ø£Ù„ØªØ±Ø§',
          duration: '3 Ø³Ø§Ø¹Ø§Øª',
          priceSedan: 30,
          priceSUV: 35,
          services: ['ØºØ³ÙŠÙ„ Ø®Ø§Ø±Ø¬ÙŠ', 'Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ', 'ØªÙ„Ù…ÙŠØ¹ Ø¯ÙŠÙƒÙˆØ±Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©', 'ØºØ³ÙŠÙ„ Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø©', 'ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø£Ø¨ÙˆØ§Ø¨', 'ØºØ³ÙŠÙ„ Ø¯Ø¨Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©', 'ØªÙ†Ø¸ÙŠÙ Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©']
        }
      };
      
      const washTypes = quality === 'all' ? ['premium', 'special', 'ultra'] : [quality];
      
      washTypes.forEach(type => {
        const wash = washDetails[type];
        washCardsGrid.innerHTML += `
          <div class="wash-card-compact">
            <h3>${wash.name}</h3>
            <div class="price">ØµØ§Ù„ÙˆÙ†: ${wash.priceSedan} Ø¯.Ùƒ | Ø¬ÙŠØ¨: ${wash.priceSUV} Ø¯.Ùƒ</div>
            <div style="font-size: 11px; color: #10b981; margin-bottom: 6px;">â± ${wash.duration}</div>
            <ul>
              ${wash.services.map(s => `<li>${s}</li>`).join('')}
            </ul>
            <button class="copy-btn-small" onclick="copyWashDetails('${type}')">ğŸ“‹ Ù†Ø³Ø®</button>
          </div>
        `;
      });
      
      formData.selectedWashes = washTypes;
      washCardsSection.classList.remove('hidden');
      
      document.getElementById('appointmentSection').classList.remove('hidden');
      
      const appointmentDate = document.getElementById('appointmentDate');
      
      if (!appointmentDate.value) {
        const today = new Date().toISOString().split('T')[0];
        appointmentDate.min = today;
        appointmentDate.value = today;
        loadCarWashAppointments(today);
      } else {
        loadCarWashAppointments(appointmentDate.value);
      }
      
      appointmentDate.onchange = () => {
        loadCarWashAppointments(appointmentDate.value);
      };
    }

    window.copyWashDetails = async function(type) {
      const washDetails = {
        premium: {
          name: 'ØºØ³ÙŠÙ„ Ù…Ù…ØªØ§Ø²',
          duration: 'Ø³Ø§Ø¹Ø© ÙˆØ§Ø­Ø¯Ø©',
          priceSedan: 7,
          priceSUV: 8,
          services: ['ØºØ³ÙŠÙ„ Ø®Ø§Ø±Ø¬ÙŠ', 'ØªÙ†Ø¸ÙŠÙ Ø¯Ø§Ø®Ù„ÙŠ', 'ØªÙ„Ù…ÙŠØ¹ Ø§Ù„ØªÙˆØ§ÙŠØ± ÙˆØ§Ù„Ø±Ù†Ù‚Ø§Øª', 'ØªÙ†Ø¸ÙŠÙ ÙØªØ­Ø§Øª Ø§Ù„ØªÙƒÙŠÙŠÙ', 'Ø¹Ø·Ø±']
        },
        special: {
          name: 'ØºØ³ÙŠÙ„ Ø®ØµÙˆØµÙŠ',
          duration: 'Ø³Ø§Ø¹ØªÙŠÙ†',
          priceSedan: 15,
          priceSUV: 17,
          services: ['ØºØ³ÙŠÙ„ Ø®Ø§Ø±Ø¬ÙŠ', 'ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ', 'ØªÙ„Ù…ÙŠØ¹ Ø¯ÙŠÙƒÙˆØ±Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©', 'Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ù‚Ø¹ Ø§Ù„Ø®ÙÙŠÙØ©', 'ØªÙ„Ù…ÙŠØ¹ Ø§Ù„ØªÙˆØ§ÙŠØ± ÙˆØ§Ù„Ø±Ù†Ù‚Ø§Øª', 'ØªÙ†Ø¸ÙŠÙ ÙØªØ­Ø§Øª Ø§Ù„ØªÙƒÙŠÙŠÙ', 'Ø¹Ø·Ø±']
        },
        ultra: {
          name: 'ØºØ³ÙŠÙ„ Ø£Ù„ØªØ±Ø§',
          duration: '3 Ø³Ø§Ø¹Ø§Øª',
          priceSedan: 30,
          priceSUV: 35,
          services: ['ØºØ³ÙŠÙ„ Ø®Ø§Ø±Ø¬ÙŠ', 'Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ', 'ØªÙ„Ù…ÙŠØ¹ Ø¯ÙŠÙƒÙˆØ±Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©', 'ØºØ³ÙŠÙ„ Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø©', 'ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø£Ø¨ÙˆØ§Ø¨', 'ØºØ³ÙŠÙ„ Ø¯Ø¨Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©', 'ØªÙ†Ø¸ÙŠÙ Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©']
        }
      };
      
      const wash = washDetails[type];
      const text = `
${wash.name}
Ù…Ø¯Ø© Ø§Ù„ØºØ³ÙŠÙ„: ${wash.duration}

Ø§Ù„Ø£Ø³Ø¹Ø§Ø±:
â€¢ ØµØ§Ù„ÙˆÙ†: ${wash.priceSedan} Ø¯.Ùƒ
â€¢ Ø¬ÙŠØ¨: ${wash.priceSUV} Ø¯.Ùƒ

Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ø´Ù…ÙˆÙ„Ø©:
${wash.services.map(s => `â€¢ ${s}`).join('\n')}
      `.trim();
      
      try {
        await navigator.clipboard.writeText(text);
        
        const buttons = document.querySelectorAll('.copy-btn-small');
        buttons.forEach(btn => {
          if (btn.onclick && btn.onclick.toString().includes(type)) {
            btn.classList.add('success');
            btn.textContent = 'âœ“ ØªÙ… Ø§Ù„Ù†Ø³Ø®!';
            
            setTimeout(() => {
              btn.classList.remove('success');
              btn.textContent = 'ğŸ“‹ Ù†Ø³Ø®';
            }, 2000);
          }
        });
      } catch (err) {
        console.error('Failed to copy:', err);
      }
    };

    async function loadCarWashAppointments(selectedDate) {
      try {
        const sheetId = '1FkWKRxRFC8UG1Ez2VzYHadHju2HARBLbdTIsr57hKXc';
        const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=WASH%20Sheet`;
        
        const response = await fetch(csvUrl, {
          mode: 'cors',
          credentials: 'omit'
        });
        if (!response.ok) throw new Error('Failed to load');
        
        const csvText = await response.text();
        const rows = parseCSV(csvText);
        
        carWashData = [];

        // Detect header indices so renamed columns (Arabic/English) still map correctly.
        const headerRow = rows[0] || [];
        const headers = headerRow.map(h => (h || '').toString().toLowerCase());

        // Prefer exact column headers (Arabic) if provided by user A..I, otherwise fallback to keyword search
        const headerMap = {};
        headers.forEach((h, i) => headerMap[h.trim()] = i);

        function findHeader(...candidates) {
          for (const c of candidates) {
            const key = c.toString().toLowerCase().trim();
            // exact match
            for (const hh in headerMap) {
              if (hh.toLowerCase().trim() === key) return headerMap[hh];
            }
            // substring match
            for (const hh in headerMap) {
              if (hh.toLowerCase().includes(key)) return headerMap[hh];
            }
          }
          return -1;
        }

        const idx = {
          timestamp: findHeader('timestamp', 'time stamp', 'timestamp', 'ØªÙˆÙ‚ÙŠØª'),
          date: findHeader('ØªØ§Ø±ÙŠØ® ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨', 'date', 'ØªØ§Ø±ÙŠØ®', 'Ø§Ù„ØªØ§Ø±ÙŠØ®'),
          time: findHeader('Ø§Ù„ÙˆÙ‚Øª', 'time'),
          qrOrder: findHeader('Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨', 'qr order', 'qr'),
          location: findHeader('Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„', 'location', 'Ù…ÙˆÙ‚Ø¹'),
          customerName: findHeader('Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„', 'customer name', 'customer'),
          customerNumber: findHeader('Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„', 'customer number', 'phone', 'Ø±Ù‚Ù…'),
          washType: findHeader('Ù†ÙˆØ¹ Ø§Ù„ØºØ³ÙŠÙ„', 'wash type', 'Ù†ÙˆØ¹'),
          payment: findHeader('Ø­Ø§Ù„Ù‡ Ø§Ù„Ø¯ÙØ¹', 'Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹', 'payment', 'Ù†Ø¹Ù…', 'Ù„Ø§')
        };

        // Fallback to legacy indices if detection failed
        const col = {
          date: idx.date >= 0 ? idx.date : 1,
          time: idx.time >= 0 ? idx.time : 2,
          qrOrder: idx.qrOrder >= 0 ? idx.qrOrder : 3,
          location: idx.location >= 0 ? idx.location : 4,
          customerName: idx.customerName >= 0 ? idx.customerName : 5,
          customerNumber: idx.customerNumber >= 0 ? idx.customerNumber : 6,
          washType: idx.washType >= 0 ? idx.washType : 7,
          payment: idx.payment >= 0 ? idx.payment : 8
        };

        for (let i = 1; i < rows.length; i++) {
          const row = rows[i];
          if (row[col.date] && row[col.time]) {
            let parsedDate = (row[col.date] || '').toString().trim();
            const dateObj = new Date(parsedDate);
            if (!isNaN(dateObj.getTime())) {
              const year = dateObj.getFullYear();
              const month = String(dateObj.getMonth() + 1).padStart(2, '0');
              const day = String(dateObj.getDate()).padStart(2, '0');
              parsedDate = `${year}-${month}-${day}`;
            }

            // helper: parse time like "10:00:00 PM", "10:00 PM", "22:00", or with seconds
            function parseTimeString(s) {
              s = (s || '').toString().trim();
              if (!s) return '';
              // capture hh:mm (ignore seconds)
              const m = s.match(/(\d{1,2}):(\d{2})/);
              if (m) {
                let hh = parseInt(m[1], 10);
                const mm = parseInt(m[2], 10);
                // detect AM/PM (including Arabic Ù…/Øµ or words)
                const isPM = /\bpm\b|Ù…(?![a-z])|Ù…Ø³Ø§Ø¡/i.test(s);
                const isAM = /\bam\b|Øµ(?![a-z])|ØµØ¨Ø§Ø­/i.test(s);
                if (isPM && hh !== 12) hh += 12;
                if (isAM && hh === 12) hh = 0;
                return `${hh}:${String(mm).padStart(2, '0')}`;
              }
              // fallback: try to parse as Date
              const d = new Date('1970-01-01T' + s);
              if (!isNaN(d.getTime())) return `${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
              return s;
            }

            // helper: normalize phone (preserve as string, trim)
            function normalizePhone(p) {
              return (p || '').toString().trim();
            }

            // helper: normalize payment to Arabic Ù†Ø¹Ù…/Ù„Ø§
            function normalizePayment(p) {
              const v = (p || '').toString().toLowerCase();
              if (!v) return '';
              if (v.includes('Ù†Ø¹Ù…') || v.includes('yes') || v === 'y' || v.includes('paid') || v === 'true') return 'Ù†Ø¹Ù…';
              if (v.includes('Ù„Ø§') || v.includes('no') || v === 'n' || v === 'false') return 'Ù„Ø§';
              return p;
            }

            const formattedTime = parseTimeString(row[col.time]);
            const phoneVal = normalizePhone(row[col.customerNumber]);
            const paymentVal = normalizePayment(row[col.payment]);

            carWashData.push({
              date: parsedDate,
              time: formattedTime,
              qrOrder: (row[col.qrOrder] || '').toString().trim(),
              customerName: (row[col.customerName] || '').toString().trim(),
              phone: phoneVal,
              location: (row[col.location] || '').toString().trim(),
              washType: (row[col.washType] || '').toString().trim(),
              payment: paymentVal
            });
          }
        }
        
        calculateAvailableSlots(selectedDate);
        
      } catch (error) {
        document.getElementById('availableSlots').innerHTML = `
          <div class="error-box">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯. ØªØ£ÙƒØ¯ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø´ÙŠØª</div>
        `;
      }
    }

    function calculateAvailableSlots(selectedDate) {
      const availableSlots = document.getElementById('availableSlots');
      
      const dateObj = new Date(selectedDate + 'T00:00:00');
      const dayOfWeek = dateObj.toLocaleDateString('ar-EG', { weekday: 'long' });
      const formattedDate = dateObj.toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' });
      
      const dayIndex = dateObj.getDay();
      const startOfYear = new Date(dateObj.getFullYear(), 0, 1);
      const days = Math.floor((dateObj - startOfYear) / (24 * 60 * 60 * 1000));
      const weekNumber = Math.ceil((days + startOfYear.getDay() + 1) / 7);
      
      if (dayIndex === 5 && weekNumber % 2 === 1) {
        availableSlots.innerHTML = `
          <div class="error-box">
            <strong>âŒ Ù…ØºÙ„Ù‚ ÙŠÙˆÙ… Ø§Ù„Ø¬Ù…Ø¹Ø©</strong><br>
            Ø£Ù‚Ø±Ø¨ Ù…ÙˆØ¹Ø¯ Ù…ØªØ§Ø­: ÙŠÙˆÙ… Ø§Ù„Ø³Ø¨Øª
          </div>
        `;
        return;
      }
      
      const todayAppointments = carWashData.filter(apt => apt.date === selectedDate);
      todayAppointments.sort((a, b) => {
        const timeA = a.time.split(':').map(Number);
        const timeB = b.time.split(':').map(Number);
        return (timeA[0] * 60 + timeA[1]) - (timeB[0] * 60 + timeB[1]);
      });
      
      let html = `
        <div style="background: #1a1a1a; border: 1px solid #F2BC1B; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
          <div style="font-size: 13px; font-weight: 700; color: #F2BC1B;">${dayOfWeek}</div>
          <div style="font-size: 12px; color: #999;">${formattedDate}</div>
        </div>
      `;
      
      const workStartMinutes = 630; // 10:30 AM
      const workEndMinutes = 1320;  // 10:00 PM
      
      const today = new Date();
      const isToday = dateObj.getDate() === today.getDate() && 
                      dateObj.getMonth() === today.getMonth() && 
                      dateObj.getFullYear() === today.getFullYear();
      
      let earliestAvailableTime = workStartMinutes;
      
      if (isToday) {
        const currentMinutes = today.getHours() * 60 + today.getMinutes();
        const roundedMinutes = Math.ceil((currentMinutes + 30) / 5) * 5;
        earliestAvailableTime = Math.max(earliestAvailableTime, roundedMinutes);
      }
      
      // Build list of appointments with their actual times
      const appointments = [];
      todayAppointments.forEach(apt => {
        const timeParts = apt.time.split(':').map(Number);
        const appointmentMinutes = timeParts[0] * 60 + timeParts[1];
        
        let washDuration = 60;
        const washType = apt.washType.toLowerCase();
        if (washType.includes('Ø®ØµÙˆØµÙŠ')) washDuration = 120;
        else if (washType.includes('Ø§Ù„ØªØ±Ø§')) washDuration = 180;
        
        appointments.push({
          start: appointmentMinutes,
          duration: washDuration,
          end: appointmentMinutes + washDuration + 30
        });
      });
      
      // Sort appointments by start time
      appointments.sort((a, b) => a.start - b.start);
      
      const selectedWashes = formData.selectedWashes || [];
      const washDurations = {
        premium: 60,
        special: 120,
        ultra: 180
      };
      
      const travelTime = 30;
      
      // Find all available time slots for each wash type
      const availableTimeSlots = {};
      
      selectedWashes.forEach(washType => {
        const duration = washDurations[washType];
        const totalDuration = duration + travelTime;
        availableTimeSlots[washType] = [];
        
        // Check before first appointment
        if (appointments.length > 0) {
          const firstAppointmentStart = appointments[0].start;
          const latestStartBeforeFirst = firstAppointmentStart - totalDuration;
          
          if (earliestAvailableTime <= latestStartBeforeFirst) {
            availableTimeSlots[washType].push({
              start: earliestAvailableTime,
              latestStart: latestStartBeforeFirst,
              end: firstAppointmentStart
            });
          }
        }
        
        // Check gaps between appointments
        for (let i = 0; i < appointments.length - 1; i++) {
          const currentAppointmentEnd = appointments[i].end;
          const nextAppointmentStart = appointments[i + 1].start;
          
          const earliestStartInGap = Math.max(currentAppointmentEnd, earliestAvailableTime);
          const latestStartInGap = nextAppointmentStart - totalDuration;
          
          if (earliestStartInGap <= latestStartInGap && earliestStartInGap + totalDuration <= nextAppointmentStart) {
            availableTimeSlots[washType].push({
              start: earliestStartInGap,
              latestStart: latestStartInGap,
              end: nextAppointmentStart
            });
          }
        }
        
        // Check after last appointment
        if (appointments.length > 0) {
          const lastAppointmentEnd = appointments[appointments.length - 1].end;
          const earliestStartAfterLast = Math.max(lastAppointmentEnd, earliestAvailableTime);
          
          if (earliestStartAfterLast + totalDuration <= workEndMinutes) {
            availableTimeSlots[washType].push({
              start: earliestStartAfterLast,
              latestStart: workEndMinutes - totalDuration,
              end: workEndMinutes
            });
          }
        } else {
          // No appointments at all
          if (earliestAvailableTime + totalDuration <= workEndMinutes) {
            availableTimeSlots[washType].push({
              start: earliestAvailableTime,
              latestStart: workEndMinutes - totalDuration,
              end: workEndMinutes
            });
          }
        }
      });
      
      // Check if any wash type has available slots
      const hasAnyAvailable = Object.values(availableTimeSlots).some(slots => slots.length > 0);
      
      if (!hasAnyAvailable) {
        html += `
          <div class="warning-box">
            <strong>âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆÙ‚Øª ÙƒØ§ÙÙ Ù„Ø£ÙŠ Ù†ÙˆØ¹ ØºØ³ÙŠÙ„ Ù…Ø­Ø¯Ø¯ Ø§Ù„ÙŠÙˆÙ…</strong><br>
            Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ ØªÙ†ØªÙ‡ÙŠ Ø§Ù„Ø³Ø§Ø¹Ø© 10:00 Ù…Ø³Ø§Ø¡Ù‹
          </div>
        `;
        
        const tomorrow = new Date(dateObj);
        tomorrow.setDate(tomorrow.getDate() + 1);
        const tomorrowDay = tomorrow.toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        
        html += `
          <div class="info-box" style="background: #1a4a2a; border-color: #10b981; margin-top: 10px;">
            <div style="font-size: 12px; font-weight: 700; color: #10b981; margin-bottom: 6px;">ğŸ’¡ Ø§Ù‚ØªØ±Ø§Ø­: ${tomorrowDay}</div>
            <div style="font-size: 11px; color: #10b981; margin: 3px 0;">â­ ØºØ³ÙŠÙ„ Ù…Ù…ØªØ§Ø²: Ø§Ø¨ØªØ¯Ø§Ø¡Ù‹ Ù…Ù† 10:30 ØµØ¨Ø§Ø­Ø§Ù‹</div>
            <div style="font-size: 11px; color: #10b981; margin: 3px 0;">ğŸ’ ØºØ³ÙŠÙ„ Ø®ØµÙˆØµÙŠ: Ø§Ø¨ØªØ¯Ø§Ø¡Ù‹ Ù…Ù† 10:30 ØµØ¨Ø§Ø­Ø§Ù‹</div>
            <div style="font-size: 11px; color: #10b981; margin: 3px 0;">ğŸ‘‘ ØºØ³ÙŠÙ„ Ø£Ù„ØªØ±Ø§: Ø§Ø¨ØªØ¯Ø§Ø¡Ù‹ Ù…Ù† 10:30 ØµØ¨Ø§Ø­Ø§Ù‹</div>
          </div>
        `;
      } else {
        html += `
          <div class="info-box" style="background: #1a4a2a; border-color: #10b981;">
            <div style="font-size: 12px; font-weight: 700; color: #10b981; margin-bottom: 6px;">âœ“ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­Ø©:</div>
        `;
        
        // Helper function to format time
        const formatTimeSimple = (minutes) => {
          const hours = Math.floor(minutes / 60);
          const mins = minutes % 60;
          const period = hours >= 12 ? 'Ù…Ø³Ø§Ø¡Ù‹' : 'ØµØ¨Ø§Ø­Ø§Ù‹';
          const displayHours = hours > 12 ? hours - 12 : (hours === 0 ? 12 : hours);
          
          if (mins === 0) {
            return `${displayHours} ${period}`;
          } else {
            return `${displayHours}:${mins.toString().padStart(2, '0')} ${period}`;
          }
        };
        
        // Helper to format time range - shows end time INCLUDING wash duration
        const formatTimeRange = (slots, washDuration) => {
          if (!slots || slots.length === 0) return '';
          
          let ranges = [];
          slots.forEach(slot => {
            const startTime = formatTimeSimple(slot.start);
            // Calculate actual end time: latestStart + wash duration (NOT including travel time)
            const latestEndTime = slot.latestStart + washDuration;
            const endTime = formatTimeSimple(latestEndTime);
            ranges.push(`Ù…Ù† ${startTime} Ø¥Ù„Ù‰ ${endTime}`);
          });
          
          return ranges.join(' â€¢ ÙˆØ£ÙŠØ¶Ø§Ù‹ ');
        };
        
        if (availableTimeSlots.premium && availableTimeSlots.premium.length > 0) {
          const timeRange = formatTimeRange(availableTimeSlots.premium, 60);
          html += `<div style="font-size: 11px; color: #10b981; margin: 3px 0;">â­ ØºØ³ÙŠÙ„ Ù…Ù…ØªØ§Ø²: ${timeRange}</div>`;
        }
        
        if (availableTimeSlots.special && availableTimeSlots.special.length > 0) {
          const timeRange = formatTimeRange(availableTimeSlots.special, 120);
          html += `<div style="font-size: 11px; color: #10b981; margin: 3px 0;">ğŸ’ ØºØ³ÙŠÙ„ Ø®ØµÙˆØµÙŠ: ${timeRange}</div>`;
        }
        
        if (availableTimeSlots.ultra && availableTimeSlots.ultra.length > 0) {
          const timeRange = formatTimeRange(availableTimeSlots.ultra, 180);
          html += `<div style="font-size: 11px; color: #10b981; margin: 3px 0;">ğŸ‘‘ ØºØ³ÙŠÙ„ Ø£Ù„ØªØ±Ø§: ${timeRange}</div>`;
        }
        
        html += `</div>`;
        
        const unavailableTypes = [];
        if (selectedWashes.includes('premium') && availableTimeSlots.premium.length === 0) unavailableTypes.push('â­ ØºØ³ÙŠÙ„ Ù…Ù…ØªØ§Ø²');
        if (selectedWashes.includes('special') && availableTimeSlots.special.length === 0) unavailableTypes.push('ğŸ’ ØºØ³ÙŠÙ„ Ø®ØµÙˆØµÙŠ');
        if (selectedWashes.includes('ultra') && availableTimeSlots.ultra.length === 0) unavailableTypes.push('ğŸ‘‘ ØºØ³ÙŠÙ„ Ø£Ù„ØªØ±Ø§');
        
        if (unavailableTypes.length > 0) {
          html += `<div class="warning-box">
            <div style="font-size: 12px; font-weight: 700; color: #fbbf24; margin-bottom: 4px;">âš ï¸ ØºÙŠØ± Ù…ØªÙˆÙØ± Ø§Ù„ÙŠÙˆÙ…:</div>`;
          
          unavailableTypes.forEach(type => {
            html += `<div style="font-size: 11px; color: #fbbf24; margin: 2px 0;">${type}</div>`;
          });
          
          html += `</div>`;
        }
      }
      
      if (todayAppointments.length > 0) {
        html += `<div style="margin-top: 12px; font-size: 12px; font-weight: 700; color: #F2BC1B; margin-bottom: 8px;">Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø¬ÙˆØ²Ø©:</div>`;
        
        html += `
          <div style="background: #1a1a1a; border: 1px solid #333; border-radius: 5px; overflow: hidden;">
            <div style="overflow-x: auto;">
              <table class="data-table">
                <thead>
                  <tr>
                    <th style="min-width: 80px;">Ø§Ù„ÙˆÙ‚Øª</th>
                    <th style="min-width: 100px;">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th style="min-width: 80px;">Ù†ÙˆØ¹ Ø§Ù„ØºØ³ÙŠÙ„</th>
                    <th style="min-width: 80px;">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                    <th style="min-width: 120px;">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                    <th style="min-width: 100px;">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                    <th style="min-width: 120px;">Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                    <th style="min-width: 100px;">Ø§Ù„Ù…Ø¯Ø©</th>
                    <th style="min-width: 90px;">Ø§Ù„Ø¯ÙØ¹</th>
                  </tr>
                </thead>
                <tbody>
        `;
        
        todayAppointments.forEach((apt) => {
          const timeParts = apt.time.split(':').map(Number);
          const hours = timeParts[0];
          const minutes = timeParts[1];
          const period = hours >= 12 ? 'Ù…Ø³Ø§Ø¡Ù‹' : 'ØµØ¨Ø§Ø­Ø§Ù‹';
          const displayHours = hours > 12 ? hours - 12 : (hours === 0 ? 12 : hours);
          const displayTime = `${displayHours}:${minutes.toString().padStart(2, '0')} ${period}`;
          
          let washDuration = 60;
          const washType = apt.washType.toLowerCase();
          if (washType.includes('Ø®ØµÙˆØµÙŠ')) washDuration = 120;
          else if (washType.includes('Ø§Ù„ØªØ±Ø§')) washDuration = 180;
          
          const startMinutes = timeParts[0] * 60 + timeParts[1];
          const endMinutes = startMinutes + washDuration;
          const endHours = Math.floor(endMinutes / 60);
          const endMins = endMinutes % 60;
          const endPeriod = endHours >= 12 ? 'Ù…Ø³Ø§Ø¡Ù‹' : 'ØµØ¨Ø§Ø­Ø§Ù‹';
          const endDisplayHours = endHours > 12 ? endHours - 12 : (endHours === 0 ? 12 : endHours);
          const endDisplayTime = `${endDisplayHours}:${endMins.toString().padStart(2, '0')} ${endPeriod}`;
          
          let orderStatus = '';
          let statusColor = '';
          
          const selectedDate = document.getElementById('appointmentDate').value;
          const today = new Date();
          const todayStr = today.toISOString().split('T')[0];
          const isToday = selectedDate === todayStr;
          
          if (isToday) {
            const currentMinutes = today.getHours() * 60 + today.getMinutes();
            const minutesUntilStart = startMinutes - currentMinutes;
            const minutesSinceEnd = currentMinutes - endMinutes;
            
            if (minutesSinceEnd > 0) {
              orderStatus = 'âœ… ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡';
              statusColor = '#10b981';
            } else if (currentMinutes >= startMinutes && currentMinutes < endMinutes) {
              orderStatus = 'ğŸ”„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°';
              statusColor = '#3b82f6';
            } else if (minutesUntilStart <= 30 && minutesUntilStart > 0) {
              orderStatus = 'ğŸš— Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚';
              statusColor = '#f59e0b';
            } else if (minutesUntilStart > 0) {
              orderStatus = 'ğŸ“… Ù…Ø­Ø¬ÙˆØ²';
              statusColor = '#3b82f6';
            } else {
              orderStatus = 'ğŸ“‹ Ù…Ø­Ø¬ÙˆØ²';
              statusColor = '#3b82f6';
            }
          } else {
            const selectedDateObj = new Date(selectedDate + 'T00:00:00');
            const todayDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            
            if (selectedDateObj < todayDate) {
              orderStatus = 'âœ… ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡';
              statusColor = '#10b981';
            } else {
              orderStatus = 'ğŸ“… Ù…Ø­Ø¬ÙˆØ²';
              statusColor = '#3b82f6';
            }
          }
          
          const paymentVal = (apt.payment || '').toString().toLowerCase();
          let paymentStatus = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
          if (paymentVal.includes('Ù†Ø¹Ù…') || paymentVal.includes('yes') || paymentVal === 'y' || paymentVal === 'true') {
            paymentStatus = 'âœ… ØªÙ…';
          } else if (paymentVal.includes('Ù„Ø§') || paymentVal.includes('no') || paymentVal === 'n' || paymentVal === 'false') {
            paymentStatus = 'âŒ Ù„Ù… ÙŠØªÙ…';
          }
          
          html += `
            <tr>
              <td style="font-weight: 600; color: #F2BC1B;">${displayTime}</td>
              <td style="color: ${statusColor}; font-weight: 600;">${orderStatus}</td>
              <td>${apt.washType}</td>
              <td>${apt.qrOrder || '-'}</td>
              <td>${apt.customerName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
              <td style="direction: ltr; text-align: center;">${apt.phone || '-'}</td>
              <td>${apt.location || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
              <td style="font-size: 10px; color: #999;">${displayTime} - ${endDisplayTime}<br>(${washDuration} Ø¯Ù‚ÙŠÙ‚Ø©)</td>
              <td>${paymentStatus}</td>
            </tr>
          `;
        });
        
        html += `
                </tbody>
              </table>
            </div>
          </div>
        `;
      }
      
      availableSlots.innerHTML = html;
    }

    // Render Refunds Interface
    function renderRefundsInterface() {
      const contentArea = document.getElementById('contentArea');
      contentArea.innerHTML = `
        <div class="form-section full-width">
          <div style="display: flex; gap: 10px; margin-bottom: 12px;">
            <button id="registerRefundBtn" class="btn-primary" style="flex: 1; background: #10b981; margin-top: 0;">âœï¸ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button>
          </div>
          <h3 class="section-title">Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
          <div class="form-field">
            <input type="text" id="customerNumberSearch" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" style="font-size: 16px; padding: 12px;">
          </div>
        </div>
        
        <div id="refundsResults" class="hidden" style="grid-column: 1 / -1; width: 100%; box-sizing: border-box; padding: 0; display: grid; grid-template-columns: 1fr; gap: 0;">
        </div>
      `;
      
      // Register Refund Button
      document.getElementById('registerRefundBtn').onclick = () => {
        const formUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSdrJLZVsDsC1sVC4uIIsFMrhjhT_1xCPbPiBBKqEM_b5B0v6w/viewform?usp=dialog';
        window.open(formUrl, 'refundForm', 'width=800,height=600');
      };
      
      // Search functionality - Ø¨Ø­Ø« Ø¯Ù‚ÙŠÙ‚ ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† ØªØµÙÙŠØ© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø©
      const searchInput = document.getElementById('customerNumberSearch');
      
      searchInput.onkeypress = (event) => {
        if (event.key === 'Enter') {
          const query = searchInput.value.trim();
          
          if (!query) {
            document.getElementById('refundsResults').classList.add('hidden');
            document.getElementById('refundsResults').innerHTML = '';
            return;
          }
          
          searchRefunds(query);
        }
      };
      
      // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¹Ù†Ø¯ Ù…Ø³Ø­ Ø§Ù„Ù…Ø¯Ø®Ù„
      searchInput.oninput = () => {
        if (!searchInput.value.trim()) {
          document.getElementById('refundsResults').classList.add('hidden');
          document.getElementById('refundsResults').innerHTML = '';
        }
      };
    }
    
    function searchRefunds(customerNumber) {
      const refundsSheet = '1HmRWypUMbHChUUSVvogJ2jdCZeHf8aCo3DLRkeL7DLw';
      const resultsContainer = document.getElementById('refundsResults');

      fetch(`https://docs.google.com/spreadsheets/d/${refundsSheet}/gviz/tq?tqx=out:csv`)
        .then(response => response.text())
        .then(csvText => {
          const rows = parseCSV(csvText);

          if (rows.length < 2) {
            resultsContainer.innerHTML = `
              <div class="form-section full-width">
                <div class="warning-box">âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©</div>
              </div>
            `;
            resultsContainer.classList.remove('hidden');
            return;
          }

          const headerRow = rows[0] || [];
          const foundResults = [];
          const searchLower = customerNumber.toLowerCase().trim();

          for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            if (!row || row.length === 0 || !row.some(cell => cell && cell.toString().trim())) continue;

            const orderNumber = (row[1] || '').toString().toLowerCase().trim();
            const customerNum = (row[2] || '').toString().toLowerCase().trim();

            // Ø¨Ø­Ø« Ø¯Ù‚ÙŠÙ‚ - Ù…Ø·Ø§Ø¨Ù‚Ø© ØªØ§Ù…Ø© ÙÙ‚Ø·
            if (orderNumber === searchLower || customerNum === searchLower) {
              foundResults.push({ headers: headerRow, rowData: row });
            }
          }

          if (foundResults.length === 0) {
            resultsContainer.innerHTML = `
              <div class="form-section full-width">
                <div class="warning-box">âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¨Ø­Ø«: "${customerNumber}"</div>
              </div>
            `;
            resultsContainer.classList.remove('hidden');
            return;
          }

          let html = '';
          let headers = [];
          let allRows = [];

          foundResults.forEach(result => {
            if (headers.length === 0) {
              headers = result.headers || [];
            }
            allRows.push(result.rowData);
          });

          html += `
            <div class="data-table-container" style="margin-bottom: 15px; grid-column: 1 / -1;">
              <div class="table-header">Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹Ø©</div>
              <div style="overflow-x: auto; width: 100%;">
                <table class="data-table" style="width: 100%; table-layout: auto;">
                  <thead>
                    <tr>
          `;

          const columnsWithData = [];
          if (allRows.length > 0) {
            headers.forEach((header, idx) => {
              let hasData = false;
              for (let row of allRows) {
                if (row[idx] && row[idx].toString().trim() !== '') {
                  hasData = true;
                  break;
                }
              }
              if (header && hasData) {
                columnsWithData.push({ header: header.toString(), idx });
              }
            });
          }

          columnsWithData.forEach(col => {
            html += `<th style="white-space: nowrap; padding: 11px 16px;">${col.header}</th>`;
          });
          
          // Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„
          html += `<th style="white-space: nowrap; padding: 11px 16px;">Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹</th>`;

          html += `
                    </tr>
                  </thead>
                  <tbody>
          `;

          allRows.forEach(row => {
            html += `<tr>`;
            columnsWithData.forEach(col => {
              let value = row[col.idx] || '-';
              value = value.toString();
              if (value.toLowerCase() === 'fawzipor@gmail.com') value = 'ÙÙˆØ²ÙŠ Ø¯Ø§Ù…Ø³';
              html += `<td style="white-space: nowrap; padding: 10px 16px;">${value}</td>`;
            });
            
            // Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø­Ø§Ù„Ø© - Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£ÙˆÙ„ Ø¹Ù…ÙˆØ¯ ÙØ§Ø±Øº ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹
            let refundStatus = '-';
            let refundIcon = 'â“';
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø­Ø§Ù„Ø© (Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø¨Ø¹Ù†ÙˆØ§Ù† "Ø§Ù„Ø­Ø§Ù„Ø©" Ø£Ùˆ "Status" Ø£Ùˆ "Ù†Ø¹Ù…/Ù„Ø§")
            let refundStatusIdx = -1;
            for (let i = 0; i < headers.length; i++) {
              const headerLower = (headers[i] || '').toString().toLowerCase();
              if (headerLower.includes('Ø­Ø§Ù„Ø©') || headerLower.includes('status') || headerLower.includes('Ø§Ø³ØªØ±Ø¬Ø§Ø¹')) {
                refundStatusIdx = i;
                break;
              }
            }
            
            if (refundStatusIdx !== -1) {
              const statusValue = (row[refundStatusIdx] || '').toString().trim().toLowerCase();
              if (statusValue === 'Ù†Ø¹Ù…' || statusValue === 'yes' || statusValue === 'ØªÙ…') {
                refundStatus = 'ØªÙ… Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹';
                refundIcon = 'âœ…';
              } else if (statusValue === '' || statusValue === 'Ù„Ø§' || statusValue === 'no') {
                refundStatus = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹';
                refundIcon = 'âŒ';
              }
            }
            
            html += `<td style="white-space: nowrap; padding: 10px 16px;">${refundIcon} ${refundStatus}</td>`;
            html += `</tr>`;
          });

          html += `
                  </tbody>
                </table>
              </div>
            </div>
          `;

          resultsContainer.innerHTML = html;
          resultsContainer.classList.remove('hidden');
          resultsContainer.style.gridColumn = '1 / -1';
        })
        .catch(error => {
          console.error('Error searching refunds:', error);
          resultsContainer.innerHTML = `
            <div class="form-section full-width">
              <div class="error-box">âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
            </div>
          `;
          resultsContainer.classList.remove('hidden');
        });
    }

    // Render Insurance Interface
    function renderInsuranceInterface() {
      const contentArea = document.getElementById('contentArea');
      contentArea.innerHTML = `
        <div class="form-section full-width">
          <h3 class="section-title">Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ØªØ£Ù…ÙŠÙ†Ø§Øª</h3>
          <div class="form-field">
            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
              <span>Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø© Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</span>
              <span id="insuranceInfoIcon" style="cursor: pointer; background: #3b82f6; color: #fff; width: 20px; height: 20px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; box-shadow: 0 2px 6px rgba(59, 130, 246, 0.4);">i</span>
            </label>
            <input type="text" list="insuranceSuggestions" id="insuranceSearch" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø© Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" style="font-size: 16px; padding: 12px;">
            <datalist id="insuranceSuggestions"></datalist>
          </div>
          
          <div id="insuranceInfoBox" class="hidden" style="background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); border: 2px solid #60a5fa; border-radius: 8px; padding: 16px; margin-top: 12px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
              <span style="font-size: 24px;">â„¹ï¸</span>
              <h4 style="color: #fff; font-size: 15px; font-weight: 700; margin: 0;">Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„ØªØ£Ù…ÙŠÙ†</h4>
            </div>
            <ul style="list-style: none; padding: 0; margin: 0; color: #dbeafe;">
              <li style="padding: 6px 0; padding-right: 20px; position: relative; font-size: 13px; line-height: 1.5;">
                <span style="position: absolute; right: 0; color: #60a5fa;">âœ“</span>
                Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¨Ù†Ø¬Ø± (Ø±Ù‚Ø¹Ø© Ø®Ø§Ø±Ø¬ÙŠØ© â€“ ØªØ±ÙƒÙŠØ¨ Ø³Ø¨ÙŠØ± â€“ ØªØ¹Ø¨Ø¦Ø© Ù‡ÙˆØ§Ø¡)
              </li>
              <li style="padding: 6px 0; padding-right: 20px; position: relative; font-size: 13px; line-height: 1.5;">
                <span style="position: absolute; right: 0; color: #60a5fa;">âœ“</span>
                ÙØªØ­ Ù‚ÙÙ„
              </li>
              <li style="padding: 6px 0; padding-right: 20px; position: relative; font-size: 13px; line-height: 1.5;">
                <span style="position: absolute; right: 0; color: #60a5fa;">âœ“</span>
                Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ø·Ø§Ø±ÙŠØ©
              </li>
              <li style="padding: 6px 0; padding-right: 20px; position: relative; font-size: 13px; line-height: 1.5;">
                <span style="position: absolute; right: 0; color: #60a5fa;">âœ“</span>
                ØªØ¹Ø¨Ø¦Ø© Ø¨Ù†Ø²ÙŠÙ† (ÙŠØªÙ… Ø¯ÙØ¹ Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨Ù†Ø²ÙŠÙ† ÙÙ‚Ø·)
              </li>
              <li style="padding: 6px 0; padding-right: 20px; position: relative; font-size: 13px; line-height: 1.5;">
                <span style="position: absolute; right: 0; color: #60a5fa;">âœ“</span>
                ÙˆÙ†Ø´ Ø¹Ø§Ø¯ÙŠ (Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø±ÙŠÙ‚ ÙÙ‚Ø·ØŒ ÙˆÙÙŠ Ø§Ù„ÙƒØ±Ø§Ø¬/Ø§Ù„Ù…Ù†Ø²Ù„ Ø¨Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©)
              </li>
            </ul>
          </div>
        </div>
        
        <div id="insuranceResults" class="hidden">
        </div>
      `;
      
      const infoIcon = document.getElementById('insuranceInfoIcon');
      const infoBox = document.getElementById('insuranceInfoBox');
      
      infoIcon.onclick = () => {
        if (infoBox.classList.contains('hidden')) {
          infoBox.classList.remove('hidden');
          infoIcon.style.background = '#10b981';
        } else {
          infoBox.classList.add('hidden');
          infoIcon.style.background = '#3b82f6';
        }
      };
      
      const searchInput = document.getElementById('insuranceSearch');
      let searchTimeout;
      
      searchInput.oninput = () => {
        clearTimeout(searchTimeout);
        
        const query = searchInput.value.trim();
        
        if (query.length >= 1) {
          updateInsuranceSuggestions(query);
        }
        
        searchTimeout = setTimeout(() => {
          if (query.length >= 2) {
            searchInsurance(query);
          } else {
            document.getElementById('insuranceResults').innerHTML = '';
            document.getElementById('insuranceResults').classList.add('hidden');
          }
        }, 300);
      };
    }
    
    function updateInsuranceSuggestions(query) {
      const datalist = document.getElementById('insuranceSuggestions');
      const insuranceSheets = [
        { name: 'ØªØ£Ù…ÙŠÙ† ÙˆØ±Ø¨Ù‡' },
        { name: 'ØªØ£Ù…ÙŠÙ† ØµÙÙŠÙ†Ù‡ VIP' },
        { name: 'ØªØ£Ù…ÙŠÙ† Ø¥ÙŠÙ„Ø§Ù' }
      ];
      
      let suggestions = new Set();
      
      insuranceSheets.forEach(sheet => {
        if (!sheetsData[sheet.name]) return;
        
        const rows = sheetsData[sheet.name];
        if (rows.length < 2) return;
        
        const headers = rows[0];
        
        let customerNameCol = -1;
        let plateNumberCol = -1;
        
        for (let i = 0; i < headers.length; i++) {
          const header = (headers[i] || '').toLowerCase().trim();
          if (header.includes('customer') && header.includes('name')) {
            customerNameCol = i;
          }
          if (header.includes('plate') && header.includes('number')) {
            plateNumberCol = i;
          }
        }
        
        for (let i = 1; i < rows.length && suggestions.size < 20; i++) {
          const row = rows[i];
          
          if (customerNameCol !== -1 && row[customerNameCol]) {
            const customerName = (row[customerNameCol] || '').toString();
            if (customerName.toLowerCase().includes(query.toLowerCase())) {
              suggestions.add(customerName);
            }
          }
          
          if (plateNumberCol !== -1 && row[plateNumberCol]) {
            const plateNumber = (row[plateNumberCol] || '').toString();
            if (plateNumber.toLowerCase().includes(query.toLowerCase())) {
              suggestions.add(plateNumber);
            }
          }
        }
      });
      
      datalist.innerHTML = Array.from(suggestions).slice(0, 15).map(s => `<option value="${s}">`).join('');
    }
    
    function searchInsurance(query) {
      const resultsContainer = document.getElementById('insuranceResults');
      const insuranceSheets = [
        { name: 'ØªØ£Ù…ÙŠÙ† ÙˆØ±Ø¨Ù‡', displayName: 'ØªØ£Ù…ÙŠÙ† ÙˆØ±Ø¨Ù‡' },
        { name: 'ØªØ£Ù…ÙŠÙ† ØµÙÙŠÙ†Ù‡ VIP', displayName: 'ØªØ£Ù…ÙŠÙ† ØµÙÙŠÙ†Ù‡ VIP' },
        { name: 'ØªØ£Ù…ÙŠÙ† Ø¥ÙŠÙ„Ø§Ù', displayName: 'ØªØ£Ù…ÙŠÙ† Ø¥ÙŠÙ„Ø§Ù' }
      ];
      
      let foundResults = [];
      
      insuranceSheets.forEach(sheet => {
        if (!sheetsData[sheet.name]) return;
        
        const rows = sheetsData[sheet.name];
        if (rows.length < 2) return;
        
        const headers = rows[0];
        
        let customerNameCol = -1;
        let plateNumberCol = -1;
        
        for (let i = 0; i < headers.length; i++) {
          const header = (headers[i] || '').toLowerCase().trim();
          if (header.includes('customer') && header.includes('name')) {
            customerNameCol = i;
          }
          if (header.includes('plate') && header.includes('number')) {
            plateNumberCol = i;
          }
        }
        
        for (let i = 1; i < rows.length; i++) {
          const row = rows[i];
          let match = false;
          
          if (customerNameCol !== -1 && row[customerNameCol]) {
            const customerName = (row[customerNameCol] || '').toString().toLowerCase();
            if (customerName.includes(query.toLowerCase())) {
              match = true;
            }
          }
          
          if (plateNumberCol !== -1 && row[plateNumberCol]) {
            const plateNumber = (row[plateNumberCol] || '').toString().toLowerCase();
            if (plateNumber.includes(query.toLowerCase())) {
              match = true;
            }
          }
          
          if (match) {
            // Check if row has any non-empty data
            const hasData = row.some(cell => cell && cell.toString().trim() !== '');
            if (hasData) {
              foundResults.push({
                sheetName: sheet.displayName,
                headers: headers,
                rowData: row
              });
            }
          }
        }
      });
      
      if (foundResults.length === 0) {
        resultsContainer.innerHTML = `
          <div class="form-section full-width">
            <div class="warning-box">
              âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¨Ø­Ø«: "${query}"
            </div>
          </div>
        `;
        resultsContainer.classList.remove('hidden');
        return;
      }
      
      let html = '';
      
      foundResults.forEach((result, index) => {
        html += `
          <div class="data-table-container" style="margin-bottom: 15px; grid-column: 1 / -1;">
            <div class="table-header">${result.sheetName}</div>
            <div style="overflow-x: auto; width: 100%;">
              <table class="data-table" style="width: 100%; table-layout: auto;">
                <thead>
                  <tr>
        `;
        
        // Filter headers to show only those with data
        const columnsWithData = [];
        result.headers.forEach((header, idx) => {
          if (header && result.rowData[idx] && result.rowData[idx].toString().trim() !== '') {
            columnsWithData.push({ header, idx });
          }
        });
        
        columnsWithData.forEach(col => {
          html += `<th style="white-space: nowrap; padding: 11px 16px;">${col.header}</th>`;
        });
        
        html += `
                  </tr>
                </thead>
                <tbody>
                  <tr>
        `;
        
        columnsWithData.forEach(col => {
          const value = result.rowData[col.idx] || '-';
          html += `<td style="white-space: nowrap; padding: 10px 16px;">${value}</td>`;
        });
        
        html += `
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        `;
      });
      
      resultsContainer.innerHTML = html;
      resultsContainer.classList.remove('hidden');
    }

    // Generic Service Interface with Datalist
    function renderServiceWithDatalist(title, sheetName, columns, note = '') {
      const contentArea = document.getElementById('contentArea');
      contentArea.innerHTML = `
        <div class="form-section full-width">
          <h3 class="section-title">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</h3>
          <div class="form-field">
            <input type="text" list="areaOptions" id="areaSelect" class="form-control" placeholder="Ø§ÙƒÙ†Ø¨ Ø£Ùˆ Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©">
            <datalist id="areaOptions"></datalist>
          </div>
          ${note}
        </div>
        
        <div id="serviceResultSection" class="data-table-container hidden">
          <div class="table-header">${title}</div>
          <div class="table-scroll">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Ø§Ù„Ø¨ÙŠØ§Ù†</th>
                  <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                </tr>
              </thead>
              <tbody id="serviceResultBody">
              </tbody>
            </table>
          </div>
        </div>
      `;
      
      loadAreaOptionsDatalist(sheetName, columns, () => {
        calculateServicePrice(sheetName, columns);
      });
    }

    function loadAreaOptionsDatalist(sheetName, columns, callback) {
      const areaSelect = document.getElementById('areaSelect');
      const areaDatalist = document.getElementById('areaOptions');
      
      if (!sheetsData[sheetName]) {
        areaDatalist.innerHTML = '<option value="">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</option>';
        return;
      }
      
      const rows = sheetsData[sheetName];
      const areas = [];
      
      for (let i = 2; i < rows.length; i++) {
        const row = rows[i];
        columns.forEach((colIndex, idx) => {
          if (idx % 3 === 0 && row[colIndex]) {
            areas.push(row[colIndex]);
          }
        });
      }
      
      const uniqueAreas = [...new Set(areas)].filter(Boolean);
      areaDatalist.innerHTML = uniqueAreas.map(area => `<option value="${area}">${area}</option>`).join('');
      
      const newAreaSelect = areaSelect.cloneNode(true);
      areaSelect.parentNode.replaceChild(newAreaSelect, areaSelect);
      
      // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« onfocus Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
      newAreaSelect.onfocus = function() {
        if (this.value === '') {
          this.dispatchEvent(new Event('input', { bubbles: true }));
          // Ù…Ø­Ø§ÙƒØ§Ø© ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
          this.click();
        }
      };
      
      newAreaSelect.oninput = () => {
        formData.area = newAreaSelect.value.trim();
        
        const resultSection = document.getElementById('serviceResultSection') || 
                             document.getElementById('tireResultSection') || 
                             document.getElementById('balanceResultSection') ||
                             document.getElementById('mechResultSection') ||
                             document.getElementById('fuelResultSection');
        
        if (!formData.area) {
          if (resultSection) {
            resultSection.classList.add('hidden');
          }
          
          if (currentService === 'fuel') {
            document.querySelectorAll('[data-fuel]').forEach(btn => btn.classList.remove('active'));
            formData.fuelType = null;
          }
          
          if (currentService === 'balance' && formData.tireSource === 'customer') {
            const tireCountInput = document.getElementById('tireCountInput');
            if (tireCountInput) {
              tireCountInput.value = '';
              formData.tireCount = 0;
            }
          }
          
          if (currentService === 'mechanical' && formData.mechanicalService === 'brakes') {
            document.querySelectorAll('[data-disk]').forEach(btn => {
              btn.classList.remove('active');
              if (btn.dataset.disk === 'no') {
                btn.classList.add('active');
              }
            });
            formData.diskTurning = 'no';
          }
          
          return;
        }
        
        if (formData.area && callback) {
          callback();
        }
      };
    }

    function calculateServicePrice(sheetName, columns) {
      const rows = sheetsData[sheetName];
      if (!rows || !formData.area) return;
      
      let price = null;
      let cancellation = null;
      
      for (let i = 2; i < rows.length; i++) {
        const row = rows[i];
        
        if (row[columns[0]] === formData.area) {
          price = row[columns[1]];
          cancellation = row[columns[2]];
          break;
        }
        
        if (columns.length > 3 && row[columns[3]] === formData.area) {
          price = row[columns[4]];
          cancellation = row[columns[5]];
          break;
        }
      }
      
      if (!price) {
        document.getElementById('serviceResultSection').classList.add('hidden');
        return;
      }
      
      const tbody = document.getElementById('serviceResultBody');
      tbody.innerHTML = `
        <tr>
          <td>Ø³Ø¹Ø± Ø§Ù„Ø®Ø¯Ù…Ø©</td>
          <td class="highlight">${parseFloat(price).toFixed(2)} ${config.currency}</td>
        </tr>
        <tr>
          <td>Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡</td>
          <td>${cancellation ? parseFloat(cancellation).toFixed(2) + ' ' + config.currency : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
        </tr>
      `;
      
      document.getElementById('serviceResultSection').classList.remove('hidden');
    }

    // Option 1: Google Sheets Webhook (Apps Script) â€” leave empty to disable
    const GOOGLE_SHEETS_WEBHOOK = '';

    // Google Form submission using pre-filled link
    const FORM_ID = 'e/1FAIpQLScQh0wzxb2oVHXTtPx-NZdbBX63IhaNuMLNag-rPeMdwQVKNw'; // Form ID from the sharing URL
    const FORM_ACTION = `https://docs.google.com/forms/d/${FORM_ID}/viewform?usp=pp_url`; // Base URL with pp_url parameter

    // Map payload keys to Google Form entry ids (for pre-filled link parameters)
    const entryMapping = {
      date: 'entry.1589254434', // Date field
      time: 'entry.1405698644', // Time field
      qrOrder: 'entry.1649370181', // QR ORDER field
      customerName: 'entry.1226088444', // Customer Name field
      phone: 'entry.1698262844', // Customer Number field
      location: 'entry.920891999', // Customer Location field
      washType: 'entry.897996772', // Wash Type field
      payment: 'entry.929707556' // Payment yes/no field
    };

    /**
     * Post booking payload to Google Sheets webhook.
     * Expects the webhook to accept JSON and return HTTP 200 on success.
     */
    async function postToGoogleSheet(payload) {
      if (FORM_ACTION) {
        // If FORM_ACTION set, submit to Google Form instead of Apps Script
        return submitToGoogleForm(payload);
      }

      if (!GOOGLE_SHEETS_WEBHOOK) {
        console.warn('No remote configured (GOOGLE_SHEETS_WEBHOOK or FORM_ACTION). Skipping remote push.');
        return { ok: false, reason: 'no-remote' };
      }

      try {
        const res = await fetch(GOOGLE_SHEETS_WEBHOOK, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        return res;
      } catch (err) {
        console.error('postToGoogleSheet error', err);
        throw err;
      }
    }

    // Submit to Google Form by opening a pre-filled link in a new window
    function submitToGoogleForm(payload) {
      return new Promise((resolve) => {
        if (!FORM_ACTION) return resolve({ ok: false, reason: 'no-form' });

        // Build the pre-filled link
        let url = FORM_ACTION;
        Object.keys(entryMapping).forEach(key => {
          const fieldName = entryMapping[key];
          const value = encodeURIComponent(payload[key] || '');
          url += `&${fieldName}=${value}`;
        });

        // Open the form in a new window
        window.open(url, 'googleFormWindow', 'width=800,height=600');
        resolve({ ok: true });
      });
    }

    // Load data on page load
    loadAllSheets();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b5a74feb5de51ca',t:'MTc2NzAyMzQ2Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
