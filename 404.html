<!doctype html>
<html lang="ar" dir="rtl" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù…Ø­Ù„Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ§Øª</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&amp;display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Tajawal', sans-serif; }
    .upload-zone {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(6, 78, 59, 0.05) 100%);
      border: 2px dashed #10b981;
      transition: all 0.3s ease;
    }
    .upload-zone:hover, .upload-zone.drag-over {
      border-color: #059669;
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(6, 78, 59, 0.1) 100%);
      transform: scale(1.01);
    }
    .result-card {
      background: linear-gradient(145deg, #ffffff 0%, #f0fdf4 100%);
      box-shadow: 0 4px 20px rgba(16, 185, 129, 0.15);
    }
    .table-header {
      background: linear-gradient(90deg, #064e3b 0%, #047857 100%);
    }
    .battery-icon {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
  <style>body { box-sizing: border-box; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full bg-gradient-to-br from-emerald-900 via-emerald-800 to-teal-900 overflow-auto">
  <div class="min-h-full p-6 md:p-10"><!-- Header -->
   <header class="text-center mb-10 fade-in">
    <div class="inline-flex items-center gap-3 mb-4">
     <svg class="w-12 h-12 text-emerald-400 battery-icon" fill="currentColor" viewbox="0 0 24 24"><path d="M17 4h-3V2h-4v2H7a2 2 0 00-2 2v16a2 2 0 002 2h10a2 2 0 002-2V6a2 2 0 00-2-2zm0 18H7V6h10v16z" /> <path d="M9 8h6v3H9zm0 5h6v3H9zm0 5h4v2H9z" opacity="0.5" />
     </svg>
     <h1 id="pageTitle" class="text-3xl md:text-4xl font-extrabold text-white">Ù…Ø­Ù„Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ§Øª</h1>
    </div>
    <p class="text-emerald-200 text-lg">Ø§Ø±ÙØ¹ Ù…Ù„Ù Excel Ù„Ø¬Ù…Ø¹ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…ØªÙƒØ±Ø±Ø© Ù„ÙƒÙ„ Ù…Ù‚Ø§Ø³ Ø¨Ø·Ø§Ø±ÙŠØ©</p>
   </header><!-- Upload Zone -->
   <div class="max-w-2xl mx-auto mb-10">
    <div id="uploadZone" class="upload-zone rounded-2xl p-10 text-center cursor-pointer transition-all"><input type="file" id="fileInput" accept=".xlsx,.xls,.csv" class="hidden">
     <svg class="w-16 h-16 mx-auto mb-4 text-emerald-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
     </svg>
     <p class="text-emerald-700 font-bold text-xl mb-2">Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</p>
     <p class="text-emerald-600 text-sm">ÙŠØ¯Ø¹Ù… Ù…Ù„ÙØ§Øª Excel (.xlsx, .xls) Ùˆ CSV</p>
    </div>
    <p id="fileName" class="text-center text-emerald-300 mt-3 hidden"></p>
   </div><!-- Results Section -->
   <div id="resultsSection" class="hidden max-w-4xl mx-auto fade-in">
    <div class="result-card rounded-2xl overflow-hidden"><!-- Stats -->
     <div class="bg-emerald-50 p-6 border-b border-emerald-200">
      <div class="flex flex-wrap justify-center gap-6">
       <div class="text-center px-6 py-3 bg-white rounded-xl shadow-sm">
        <p class="text-emerald-600 text-sm font-medium">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª</p>
        <p id="uniqueCount" class="text-3xl font-bold text-emerald-800">0</p>
       </div>
       <div class="text-center px-6 py-3 bg-white rounded-xl shadow-sm">
        <p class="text-emerald-600 text-sm font-medium">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø¯Ø¯</p>
        <p id="totalCount" class="text-3xl font-bold text-emerald-800">0</p>
       </div>
       <div class="text-center px-6 py-3 bg-white rounded-xl shadow-sm">
        <p class="text-emerald-600 text-sm font-medium">ØµÙÙˆÙ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ØµÙ„ÙŠ</p>
        <p id="originalRows" class="text-3xl font-bold text-emerald-800">0</p>
       </div>
      </div>
     </div><!-- Table -->
     <div class="overflow-x-auto">
      <table class="w-full">
       <thead class="table-header">
        <tr>
         <th class="px-6 py-4 text-right text-white font-bold text-lg">#</th>
         <th class="px-6 py-4 text-right text-white font-bold text-lg">Ù…Ù‚Ø§Ø³ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© (Bat)</th>
         <th class="px-6 py-4 text-right text-white font-bold text-lg">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ (CountOfID)</th>
        </tr>
       </thead>
       <tbody id="resultsTable" class="divide-y divide-emerald-100">
       </tbody>
      </table>
     </div><!-- Export Button -->
     <div class="p-6 bg-emerald-50 border-t border-emerald-200"><button id="exportBtn" class="w-full md:w-auto mx-auto block px-8 py-3 bg-gradient-to-r from-emerald-600 to-teal-600 text-white font-bold rounded-xl hover:from-emerald-700 hover:to-teal-700 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"> <span class="flex items-center justify-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
        </svg> ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¥Ù„Ù‰ Excel </span> </button>
     </div>
    </div>
   </div><!-- Empty State Message -->
   <div id="emptyMessage" class="hidden max-w-md mx-auto text-center p-8 bg-yellow-50 rounded-2xl border-2 border-yellow-200">
    <svg class="w-16 h-16 mx-auto mb-4 text-yellow-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
    </svg>
    <p class="text-yellow-700 font-bold text-lg">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª</p>
    <p class="text-yellow-600 mt-2">ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø¹Ù…Ø¯Ø© "Bat" Ùˆ "CountOfID"</p>
   </div>
  </div>
  <script>
    // Default configuration
    const defaultConfig = {
      page_title: 'Ù…Ø­Ù„Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ§Øª'
    };

    let processedData = [];

    // Initialize Element SDK
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (config) => {
          document.getElementById('pageTitle').textContent = config.page_title || defaultConfig.page_title;
        },
        mapToCapabilities: (config) => ({
          recolorables: [],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map([
          ['page_title', config.page_title || defaultConfig.page_title]
        ])
      });
    }

    // DOM Elements
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const fileName = document.getElementById('fileName');
    const resultsSection = document.getElementById('resultsSection');
    const resultsTable = document.getElementById('resultsTable');
    const emptyMessage = document.getElementById('emptyMessage');
    const exportBtn = document.getElementById('exportBtn');

    // Event Listeners
    uploadZone.addEventListener('click', () => fileInput.click());

    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('drag-over');
    });

    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('drag-over');
    });

    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('drag-over');
      const file = e.dataTransfer.files[0];
      if (file) processFile(file);
    });

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) processFile(file);
    });

    exportBtn.addEventListener('click', exportToExcel);

    // Process uploaded file
    function processFile(file) {
      fileName.textContent = `ğŸ“„ ${file.name}`;
      fileName.classList.remove('hidden');

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet);

          processData(jsonData);
        } catch (error) {
          console.error('Error processing file:', error);
          showEmptyMessage();
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // Process and aggregate data
    function processData(data) {
      // Find the Bat and CountOfID columns (case-insensitive)
      const batKey = Object.keys(data[0] || {}).find(k => k.toLowerCase() === 'bat');
      const countKey = Object.keys(data[0] || {}).find(k => k.toLowerCase().includes('countofid') || k.toLowerCase().includes('count'));

      if (!batKey || !countKey || data.length === 0) {
        showEmptyMessage();
        return;
      }

      // Aggregate data by Bat
      const aggregated = {};
      data.forEach(row => {
        const bat = String(row[batKey] || '').trim();
        const count = parseFloat(row[countKey]) || 0;

        if (bat) {
          if (aggregated[bat]) {
            aggregated[bat] += count;
          } else {
            aggregated[bat] = count;
          }
        }
      });

      // Convert to array and sort
      processedData = Object.entries(aggregated)
        .map(([bat, count]) => ({ bat, count }))
        .sort((a, b) => b.count - a.count);

      if (processedData.length === 0) {
        showEmptyMessage();
        return;
      }

      displayResults(data.length);
    }

    // Display results in table
    function displayResults(originalRowCount) {
      emptyMessage.classList.add('hidden');
      resultsSection.classList.remove('hidden');

      // Update stats
      document.getElementById('uniqueCount').textContent = processedData.length;
      document.getElementById('totalCount').textContent = processedData.reduce((sum, item) => sum + item.count, 0).toLocaleString('ar-SA');
      document.getElementById('originalRows').textContent = originalRowCount;

      // Build table rows
      resultsTable.innerHTML = processedData.map((item, index) => `
        <tr class="hover:bg-emerald-50 transition-colors">
          <td class="px-6 py-4 text-emerald-600 font-medium">${index + 1}</td>
          <td class="px-6 py-4">
            <span class="inline-flex items-center gap-2 px-3 py-1 bg-emerald-100 text-emerald-800 rounded-lg font-bold">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                <path d="M17 4h-3V2h-4v2H7a2 2 0 00-2 2v16a2 2 0 002 2h10a2 2 0 002-2V6a2 2 0 00-2-2z"/>
              </svg>
              ${item.bat}
            </span>
          </td>
          <td class="px-6 py-4">
            <span class="text-xl font-bold text-emerald-700">${item.count.toLocaleString('ar-SA')}</span>
          </td>
        </tr>
      `).join('');
    }

    // Show empty message
    function showEmptyMessage() {
      resultsSection.classList.add('hidden');
      emptyMessage.classList.remove('hidden');
    }

    // Export to Excel
    function exportToExcel() {
      if (processedData.length === 0) return;

      const exportData = processedData.map(item => ({
        'Bat': item.bat,
        'CountOfID': item.count
      }));

      const ws = XLSX.utils.json_to_sheet(exportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ù„Ù†ØªØ§Ø¦Ø¬');

      // Set column widths
      ws['!cols'] = [{ wch: 20 }, { wch: 15 }];

      XLSX.writeFile(wb, 'Ù†ØªØ§Ø¦Ø¬_Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ§Øª.xlsx');
    }
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9d1dd339c2fe4e76',t:'MTc3MTc1NjQwNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
